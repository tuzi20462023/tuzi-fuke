# ğŸ“š Day 6 é€šè®¯è®¾å¤‡ä¸å†…è´­ç³»ç»Ÿæ•™ç¨‹ - StoreKit 2 + è®¾å¤‡ç®¡ç†

**ç›®æ ‡**: å®ç°é€šè®¯è®¾å¤‡ç³»ç»Ÿå’Œåº”ç”¨å†…è´­ä¹°åŠŸèƒ½
**æ—¶é—´**: 3-4å°æ—¶
**å¼€å‘æ¨¡å¼**: AIè¾…åŠ©å¼€å‘ - é€šè¿‡AIæç¤ºè¯ç”Ÿæˆä»£ç 
**ç»“æœ**: ç©å®¶å¯ä»¥è´­ä¹°è®¾å¤‡å‡çº§é€šè®¯èƒ½åŠ›

---

## ğŸ¤– AIå¼€å‘ç‰¹ç‚¹

æœ¬æ•™ç¨‹é‡‡ç”¨AIè¾…åŠ©å¼€å‘æ¨¡å¼ï¼š

- âœ… **æç¤ºè¯é©±åŠ¨**: æ¯ä¸ªä»»åŠ¡éƒ½æä¾›å®Œæ•´çš„AIæç¤ºè¯
- âœ… **é—®é¢˜æ’æŸ¥æ€è·¯**: å±•ç¤ºå¦‚ä½•é€šè¿‡æ—¥å¿—å®šä½é—®é¢˜
- âœ… **çœŸå®æ¡ˆä¾‹**: åŒ…å«å®é™…å¼€å‘ä¸­é‡åˆ°çš„é—®é¢˜å’Œè§£å†³è¿‡ç¨‹

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å®Œæˆæœ¬æ•™ç¨‹åï¼Œä½ å°†æŒæ¡ï¼š

- [ ] é€šè®¯è®¾å¤‡æ•°æ®æ¨¡å‹è®¾è®¡
- [ ] è®¾å¤‡èƒ½åŠ›é™åˆ¶ï¼ˆåªæ”¶ä¸å‘ï¼‰
- [ ] StoreKit 2 å†…è´­é›†æˆ
- [ ] æœ¬åœ° StoreKit é…ç½®æ–‡ä»¶æµ‹è¯•
- [ ] è´­ä¹°åæ•°æ®åº“åŒæ­¥
- [ ] ä¹è§‚æ›´æ–°ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

---

## ğŸ“‹ åŠŸèƒ½æ·±åº¦è¡¨

| å±‚çº§ | æ¨¡å— | åŠŸèƒ½ | å®ŒæˆçŠ¶æ€ |
|------|------|------|----------|
| **L1 è®¾å¤‡** | è®¾å¤‡ç±»å‹å®šä¹‰ | æ”¶éŸ³æœº/å¯¹è®²æœº/è¥åœ°ç”µå°/æ‰‹æœº | âœ… å·²å®Œæˆ |
| **L1 è®¾å¤‡** | è®¾å¤‡èƒ½åŠ›é™åˆ¶ | æ”¶éŸ³æœºåªæ”¶ä¸å‘ | âœ… å·²å®Œæˆ |
| **L1 è®¾å¤‡** | è®¾å¤‡ç®¡ç†å™¨ | åŠ è½½/åˆ‡æ¢è®¾å¤‡ | âœ… å·²å®Œæˆ |
| **L1 è®¾å¤‡** | UIé›†æˆ | èŠå¤©ç•Œé¢æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€ | âœ… å·²å®Œæˆ |
| **L2 å†…è´­** | StoreKité…ç½® | æœ¬åœ°æµ‹è¯•äº§å“ | âœ… å·²å®Œæˆ |
| **L2 å†…è´­** | è´­ä¹°æµç¨‹ | è´­ä¹°/æ¢å¤è´­ä¹° | âœ… å·²å®Œæˆ |
| **L2 å†…è´­** | æ•°æ®åº“åŒæ­¥ | è´­ä¹°åæ·»åŠ è®¾å¤‡ | âœ… å·²å®Œæˆ |
| **L2 å†…è´­** | å•†åº—UI | è®¾å¤‡å•†åº—ç•Œé¢ | âœ… å·²å®Œæˆ |
| **L3 ä¼˜åŒ–** | ä¹è§‚æ›´æ–° | æ¶ˆæ¯ç«‹å³æ˜¾ç¤º | âœ… å·²å®Œæˆ |
| **L3 ä¼˜åŒ–** | è‡ªåŠ¨æ¿€æ´» | è´­ä¹°ååˆ‡æ¢è®¾å¤‡ | âœ… å·²å®Œæˆ |

---

## ğŸš€ ä»»åŠ¡1: åˆ›å»ºè®¾å¤‡æ•°æ®è¡¨ (10åˆ†é’Ÿ)

### ç›®æ ‡

åœ¨ Supabase ä¸­åˆ›å»ºç©å®¶è®¾å¤‡è¡¨ã€‚

### ğŸ¤– AIæç¤ºè¯ (Supabase MCP æˆ– SQL Editor)

```sql
-- ç©å®¶è®¾å¤‡è¡¨
CREATE TABLE player_devices (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES auth.users(id),
    device_type TEXT NOT NULL,
    device_name TEXT NOT NULL,
    range_km DOUBLE PRECISION DEFAULT 0,
    battery_level DOUBLE PRECISION DEFAULT 100,
    signal_strength DOUBLE PRECISION DEFAULT 100,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å¯ç”¨ RLS
ALTER TABLE player_devices ENABLE ROW LEVEL SECURITY;

-- RLS ç­–ç•¥
CREATE POLICY "Users can read own devices" ON player_devices
    FOR SELECT TO authenticated USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own devices" ON player_devices
    FOR INSERT TO authenticated WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own devices" ON player_devices
    FOR UPDATE TO authenticated USING (auth.uid() = user_id);

-- ç´¢å¼•
CREATE INDEX idx_player_devices_user_id ON player_devices(user_id);
```

### âœ… éªŒè¯

åœ¨ Supabase Table Editor ç¡®è®¤ `player_devices` è¡¨å·²åˆ›å»ºã€‚

---

## ğŸš€ ä»»åŠ¡2: åˆ›å»ºè®¾å¤‡æ•°æ®æ¨¡å‹ (20åˆ†é’Ÿ)

### ç›®æ ‡

åˆ›å»º Swift è®¾å¤‡æ•°æ®ç»“æ„ã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·å¸®æˆ‘åˆ›å»º CommunicationDevice.swift æ–‡ä»¶ï¼Œè¦æ±‚ï¼š

1. åˆ›å»º DeviceType æšä¸¾ï¼ŒåŒ…å«ï¼š
   - radio (å°æ”¶éŸ³æœº) - åªèƒ½æ¥æ”¶ï¼Œæ— é™èŒƒå›´
   - walkieTalkie (å¯¹è®²æœº) - å¯æ”¶å‘ï¼Œ3km
   - campRadio (è¥åœ°ç”µå°) - å¯æ”¶å‘ï¼Œ30km
   - cellphone (æ‰‹æœºé€šè®¯) - å¯æ”¶å‘ï¼Œ100km

2. DeviceType éœ€è¦çš„å±æ€§ï¼š
   - displayName: ä¸­æ–‡åç§°
   - canSend: Bool - æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯
   - baseRangeKm: Double - åŸºç¡€é€šè®¯èŒƒå›´
   - icon: String - SF Symbol å›¾æ ‡å

3. åˆ›å»º CommunicationDevice ç»“æ„ä½“ï¼š
   - id, userId, deviceType, deviceName
   - rangeKm, batteryLevel, signalStrength, isActive
   - createdAt, updatedAt

4. è®¡ç®—å±æ€§ï¼š
   - canSend: æ ¹æ®è®¾å¤‡ç±»å‹å’ŒçŠ¶æ€åˆ¤æ–­
   - effectiveRangeKm: å®é™…é€šè®¯èŒƒå›´

5. å®ç° Codableï¼Œä½¿ç”¨ CodingKeys æ˜ å°„ snake_case

å…³é”®è®¾è®¡ï¼šæ”¶éŸ³æœº canSend è¿”å› falseï¼Œå…¶ä»–è®¾å¤‡è¿”å› true
```

### ğŸ“ å…³é”®ä»£ç 

```swift
enum DeviceType: String, Codable, CaseIterable {
    case radio = "radio"
    case walkieTalkie = "walkie_talkie"
    case campRadio = "camp_radio"
    case cellphone = "cellphone"

    /// æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯
    var canSend: Bool {
        switch self {
        case .radio: return false  // æ”¶éŸ³æœºåªèƒ½æ¥æ”¶
        default: return true
        }
    }

    var icon: String {
        switch self {
        case .radio: return "radio"
        case .walkieTalkie: return "antenna.radiowaves.left.and.right"
        case .campRadio: return "antenna.radiowaves.left.and.right.circle"
        case .cellphone: return "iphone.radiowaves.left.and.right"
        }
    }
}
```

---

## ğŸš€ ä»»åŠ¡3: åˆ›å»ºè®¾å¤‡ç®¡ç†å™¨ (30åˆ†é’Ÿ)

### ç›®æ ‡

åˆ›å»º DeviceManager ç®¡ç†ç©å®¶è®¾å¤‡ã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·å¸®æˆ‘åˆ›å»º DeviceManager.swiftï¼Œè¦æ±‚ï¼š

1. ä½¿ç”¨å•ä¾‹æ¨¡å¼ + @MainActor
2. Published å±æ€§ï¼š
   - devices: [CommunicationDevice] - è®¾å¤‡åˆ—è¡¨
   - activeDevice: CommunicationDevice? - å½“å‰æ¿€æ´»è®¾å¤‡
   - isLoading: Bool
   - errorMessage: String?

3. å…¬å¼€æ–¹æ³•ï¼š
   - loadDevices() async - åŠ è½½ç”¨æˆ·è®¾å¤‡
   - setActiveDevice(_ device) - åˆ‡æ¢æ¿€æ´»è®¾å¤‡
   - refresh() async - åˆ·æ–°è®¾å¤‡åˆ—è¡¨

4. è®¡ç®—å±æ€§ï¼š
   - canSendMessage: Bool - å½“å‰è®¾å¤‡æ˜¯å¦å¯å‘é€
   - currentRangeKm: Double - å½“å‰é€šè®¯èŒƒå›´
   - cannotSendReason: String? - ä¸èƒ½å‘é€çš„åŸå› 

5. å…³é”®é€»è¾‘ï¼š
   - åŠ è½½è®¾å¤‡åè‡ªåŠ¨é€‰æ‹©æœ€ä½³è®¾å¤‡ï¼ˆä¼˜å…ˆé€‰æ‹©å¯å‘é€çš„ï¼‰
   - ä½¿ç”¨ REST API è·å–è®¾å¤‡ï¼ˆé¿å… Swift 6 å¹¶å‘é—®é¢˜ï¼‰

å‚è€ƒ ChatManager çš„ä»£ç é£æ ¼å’Œ REST API è°ƒç”¨æ–¹å¼ã€‚
```

### ğŸš¨ å…³é”®é—®é¢˜ï¼šè´­ä¹°åè®¾å¤‡ä¸æ¿€æ´»

**é—®é¢˜å‘ç°è¿‡ç¨‹**ï¼š

ç”¨æˆ·è´­ä¹°å¯¹è®²æœºåï¼Œæ—¥å¿—æ˜¾ç¤ºï¼š
```
âœ… [StoreKitManager] è®¾å¤‡å·²æ·»åŠ åˆ°æ•°æ®åº“: å¯¹è®²æœº
âœ… [StoreKitManager] è´­ä¹°æˆåŠŸ: å¯¹è®²æœº
âœ… [DeviceManager] åŠ è½½äº† 2 ä¸ªè®¾å¤‡
ğŸ“» [DeviceManager] å½“å‰æ¿€æ´»è®¾å¤‡: å°æ”¶éŸ³æœº  â† é—®é¢˜ï¼
```

**æ ¹å› åˆ†æ**ï¼š

åŸä»£ç åªåœ¨ `activeDevice == nil` æ—¶é€‰æ‹©è®¾å¤‡ï¼š
```swift
// é”™è¯¯ä»£ç 
if activeDevice == nil {
    activeDevice = devices.first(where: { $0.deviceType != .radio })
}
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

æ¯æ¬¡åŠ è½½éƒ½é‡æ–°é€‰æ‹©æœ€ä½³è®¾å¤‡ï¼š
```swift
// æ­£ç¡®ä»£ç 
let bestDevice = devices.first(where: { $0.deviceType != .radio && $0.isActive })
    ?? devices.first(where: { $0.isActive })

if let best = bestDevice {
    activeDevice = best
}
```

### ğŸ’¡ æ•™å­¦è¦ç‚¹

**å¦‚ä½•ä¸AIæ²Ÿé€šé—®é¢˜**ï¼š

å¥½çš„åé¦ˆæ–¹å¼ï¼š
> "è´­ä¹°åè®¾å¤‡æ²¡æœ‰æ¿€æ´»ï¼Œæ—¥å¿—æ˜¾ç¤ºåŠ è½½äº†2ä¸ªè®¾å¤‡ä½†æ¿€æ´»çš„è¿˜æ˜¯å°æ”¶éŸ³æœº"

ä¸å¤Ÿå¥½çš„åé¦ˆï¼š
> "è´­ä¹°æ²¡ç”¨"

**æä¾›å…·ä½“æ—¥å¿—**èƒ½å¸®åŠ©AIå¿«é€Ÿå®šä½é—®é¢˜ã€‚

---

## ğŸš€ ä»»åŠ¡4: é›†æˆåˆ°èŠå¤©ç•Œé¢ (20åˆ†é’Ÿ)

### ç›®æ ‡

åœ¨ ChatView ä¸­æ˜¾ç¤ºè®¾å¤‡çŠ¶æ€å’Œå‘é€é™åˆ¶ã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·ä¿®æ”¹ ChatView.swiftï¼Œæ·»åŠ è®¾å¤‡åŠŸèƒ½ï¼š

1. æ·»åŠ  @StateObject private var deviceManager = DeviceManager.shared

2. åœ¨è¿æ¥çŠ¶æ€æ ä¸‹æ–¹æ·»åŠ è®¾å¤‡çŠ¶æ€æ ï¼š
   - æ˜¾ç¤ºå½“å‰è®¾å¤‡å›¾æ ‡å’Œåç§°
   - æ˜¾ç¤º"å¯æ”¶å‘"æˆ–"ä»…æ¥æ”¶"æ ‡ç­¾
   - æ˜¾ç¤ºç”µæ± ç”µé‡
   - æ·»åŠ "å‡çº§"æŒ‰é’®æ‰“å¼€è®¾å¤‡å•†åº—

3. ä¿®æ”¹è¾“å…¥æ ï¼š
   - å¦‚æœè®¾å¤‡ä¸èƒ½å‘é€ï¼Œæ˜¾ç¤ºè­¦å‘Šæç¤º
   - ç¦ç”¨è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
   - æ˜¾ç¤ºä¸èƒ½å‘é€çš„åŸå› 

4. æ·»åŠ è®¾å¤‡å•†åº—çš„ sheetï¼š
   - @State private var showDeviceStore: Bool = false
   - .sheet(isPresented: $showDeviceStore) { DeviceStoreView() }

5. åœ¨ .task ä¸­è°ƒç”¨ deviceManager.loadDevices()
```

### ğŸ“ ç•Œé¢æ•ˆæœ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ å®æ—¶è¿æ¥å·²å»ºç«‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“» å°æ”¶éŸ³æœº  [ä»…æ¥æ”¶]  ğŸ”‹100%  [å‡çº§â†‘] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  [æ¶ˆæ¯åˆ—è¡¨...]                       â”‚
â”‚                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸ å°æ”¶éŸ³æœºåªèƒ½æ¥æ”¶æ¶ˆæ¯ï¼Œæ— æ³•å‘é€        â”‚
â”‚ [ä»…æ¥æ”¶æ¨¡å¼]              [å‘é€æŒ‰é’®ç°è‰²] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä»»åŠ¡5: åˆ›å»º StoreKit é…ç½®æ–‡ä»¶ (15åˆ†é’Ÿ)

### ç›®æ ‡

åœ¨ Xcode ä¸­åˆ›å»ºæœ¬åœ° StoreKit æµ‹è¯•é…ç½®ã€‚

### æ“ä½œæ­¥éª¤ï¼ˆéä»£ç ä»»åŠ¡ï¼‰

1. **åˆ›å»ºé…ç½®æ–‡ä»¶**
   - File â†’ New â†’ File
   - æœç´¢ "StoreKit"
   - é€‰æ‹© "StoreKit Configuration File"
   - å‘½åä¸º `Products.storekit`
   - ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•

2. **æ·»åŠ äº§å“**ï¼ˆç‚¹å‡»å·¦ä¸‹è§’ "+" æŒ‰é’®ï¼‰

   | Reference Name | Product ID | Type | Price |
   |----------------|------------|------|-------|
   | å¯¹è®²æœº | com.tuzi.device.walkietalkie | Non-Consumable | $0.99 |
   | è¥åœ°ç”µå° | com.tuzi.device.campradio | Non-Consumable | $2.99 |
   | æ‰‹æœºé€šè®¯ | com.tuzi.device.cellphone | Non-Consumable | $4.99 |

3. **é…ç½® Scheme**
   - Product â†’ Scheme â†’ Edit Scheme...
   - é€‰æ‹© "Run" â†’ Options æ ‡ç­¾
   - "StoreKit Configuration" é€‰æ‹© `Products.storekit`

### âœ… éªŒè¯

è¿è¡Œ App åï¼Œ`StoreKitManager` æ—¥å¿—åº”æ˜¾ç¤ºï¼š
```
ğŸ›’ [StoreKitManager] åŠ è½½äº† 3 ä¸ªäº§å“
   - å¯¹è®²æœº: Â¥6.00
   - è¥åœ°ç”µå°: Â¥18.00
   - æ‰‹æœºé€šè®¯: Â¥30.00
```

---

## ğŸš€ ä»»åŠ¡6: åˆ›å»º StoreKit ç®¡ç†å™¨ (45åˆ†é’Ÿ)

### ç›®æ ‡

åˆ›å»º StoreKitManager å¤„ç†å†…è´­é€»è¾‘ã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·å¸®æˆ‘åˆ›å»º StoreKitManager.swiftï¼Œä½¿ç”¨ StoreKit 2ï¼Œè¦æ±‚ï¼š

1. å®šä¹‰ ProductIDs ç»“æ„ä½“ï¼š
   - walkieTalkie = "com.tuzi.device.walkietalkie"
   - campRadio = "com.tuzi.device.campradio"
   - cellphone = "com.tuzi.device.cellphone"
   - æä¾› deviceType(for:), deviceName(for:), rangeKm(for:) æ˜ å°„æ–¹æ³•

2. åˆ›å»º PurchaseStatus æšä¸¾ï¼šidle, loading, purchasing, success, failed

3. åˆ›å»º StoreKitManager ç±»ï¼š
   - å•ä¾‹ + @MainActor
   - @Published products: [Product]
   - @Published purchasedProductIDs: Set<String>
   - @Published purchaseStatus: PurchaseStatus

4. ä¸»è¦æ–¹æ³•ï¼š
   - loadProducts() async - åŠ è½½äº§å“åˆ—è¡¨
   - purchase(_ product: Product) async -> Bool - è´­ä¹°
   - restorePurchases() async - æ¢å¤è´­ä¹°
   - isPurchased(_ productID: String) -> Bool - æ£€æŸ¥æ˜¯å¦å·²è´­ä¹°

5. å…³é”®å®ç°ï¼š
   - å¯åŠ¨æ—¶ç›‘å¬ Transaction.updatesï¼ˆå¤„ç†ä¸­æ–­çš„è´­ä¹°ï¼‰
   - è´­ä¹°æˆåŠŸåè°ƒç”¨ addDeviceToDatabase() æ·»åŠ è®¾å¤‡
   - æ·»åŠ è®¾å¤‡åè°ƒç”¨ DeviceManager.shared.loadDevices() åˆ·æ–°

6. ä½¿ç”¨ REST API æ·»åŠ è®¾å¤‡åˆ° Supabaseï¼ˆå‚è€ƒ ChatManagerï¼‰

éœ€è¦ import StoreKit, Combine, Supabase
```

### ğŸ“ å…³é”®ä»£ç ï¼šäº¤æ˜“ç›‘å¬

```swift
private func listenForTransactions() -> Task<Void, Error> {
    return Task.detached {
        for await result in Transaction.updates {
            let transaction = try await self.checkVerified(result)

            await MainActor.run {
                self.purchasedProductIDs.insert(transaction.productID)
            }

            // é‡è¦ï¼šå¤„ç†ä¹‹å‰ä¸­æ–­çš„è´­ä¹°
            await self.addDeviceToDatabase(productID: transaction.productID)
            await transaction.finish()
        }
    }
}
```

### ğŸš¨ å¸¸è§é”™è¯¯

**é”™è¯¯**: `Cannot find 'SupabaseManager' in scope`

**åŸå› **: ç¼ºå°‘ import

**ä¿®å¤**:
```swift
import Foundation
import StoreKit
import Combine    // â† æ·»åŠ 
import Supabase   // â† æ·»åŠ 
```

---

## ğŸš€ ä»»åŠ¡7: åˆ›å»ºè®¾å¤‡å•†åº—ç•Œé¢ (30åˆ†é’Ÿ)

### ç›®æ ‡

åˆ›å»º DeviceStoreView å•†åº—ç•Œé¢ã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·å¸®æˆ‘åˆ›å»º DeviceStoreView.swift è®¾å¤‡å•†åº—ç•Œé¢ï¼š

1. ä½¿ç”¨ @StateObject è§‚å¯Ÿ StoreKitManager.shared
2. @Environment(\.dismiss) ç”¨äºå…³é—­

3. ç•Œé¢ç»“æ„ï¼š
   - NavigationView åŒ…è£…
   - æ ‡é¢˜åŒºï¼šå›¾æ ‡ + "å‡çº§é€šè®¯è®¾å¤‡" + å‰¯æ ‡é¢˜
   - äº§å“åˆ—è¡¨ï¼šProductCard å¡ç‰‡
   - æ¢å¤è´­ä¹°æŒ‰é’®
   - è¯´æ˜æ–‡å­—

4. ProductCard ç»„ä»¶ï¼š
   - è®¾å¤‡å›¾æ ‡ï¼ˆæ ¹æ®äº§å“IDæ˜¾ç¤ºä¸åŒå›¾æ ‡å’Œé¢œè‰²ï¼‰
   - äº§å“åç§°å’Œæè¿°
   - é€šè®¯èŒƒå›´æ ‡ç­¾
   - ä»·æ ¼æŒ‰é’® æˆ– "å·²æ‹¥æœ‰" æ ‡è®°

5. è´­ä¹°ä¸­é®ç½©ï¼š
   - å½“ purchaseStatus == .purchasing æ—¶æ˜¾ç¤º
   - åŠé€æ˜èƒŒæ™¯ + ProgressView + "å¤„ç†ä¸­..."

6. è´­ä¹°æˆåŠŸ Alertï¼š
   - æ˜¾ç¤ºè´­ä¹°çš„è®¾å¤‡åç§°
   - ç‚¹å‡»ç¡®å®šå…³é—­å•†åº—

å‚è€ƒé¡¹ç›®ä¸­å…¶ä»– View çš„æ ·å¼ã€‚
```

### ğŸ“ ç•Œé¢é¢„è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é€šè®¯è®¾å¤‡å•†åº—          [å…³é—­] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              ğŸ“¡                      â”‚
â”‚         å‡çº§é€šè®¯è®¾å¤‡                  â”‚
â”‚     è´­ä¹°æ›´å¼ºå¤§çš„è®¾å¤‡ï¼Œæ‰©å¤§é€šè®¯èŒƒå›´       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŸ¢ å¯¹è®²æœº                 [$0.99] â”‚ â”‚
â”‚ â”‚    çŸ­è·ç¦»åŒå‘é€šè®¯è®¾å¤‡              â”‚ â”‚
â”‚ â”‚    ğŸ“¶ é€šè®¯èŒƒå›´: 3km               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŸ  è¥åœ°ç”µå°               [$2.99] â”‚ â”‚
â”‚ â”‚    ä¸­è·ç¦»é€šè®¯è®¾å¤‡ï¼Œé€‚åˆè¥åœ°ä½¿ç”¨     â”‚ â”‚
â”‚ â”‚    ğŸ“¶ é€šè®¯èŒƒå›´: 30km              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸŸ£ æ‰‹æœºé€šè®¯      [âœ… å·²æ‹¥æœ‰]      â”‚ â”‚
â”‚ â”‚    è¿œè·ç¦»é€šè®¯è®¾å¤‡                 â”‚ â”‚
â”‚ â”‚    ğŸ“¶ é€šè®¯èŒƒå›´: 100km             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚            [æ¢å¤è´­ä¹°]                â”‚
â”‚                                     â”‚
â”‚      è´­ä¹°åè®¾å¤‡å°†æ°¸ä¹…è§£é”             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä»»åŠ¡8: æ€§èƒ½ä¼˜åŒ– - ä¹è§‚æ›´æ–° (20åˆ†é’Ÿ)

### èƒŒæ™¯é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š
> "å‘é€ç•Œé¢æœ‰ç‚¹å¡é¡¿"

### é—®é¢˜åˆ†æ

1. **é”®ç›˜æ”¶èµ·é˜»å¡** - `isInputFocused = false` åŒæ­¥æ‰§è¡Œ
2. **ç­‰å¾…æœåŠ¡å™¨å“åº”** - æ¶ˆæ¯è¦ç­‰ Realtime è¿”å›æ‰æ˜¾ç¤º

### ğŸ¤– AIæç¤ºè¯

```
è¯·ä¼˜åŒ– ChatView å’Œ ChatManager çš„å‘é€æ¶ˆæ¯ä½“éªŒï¼š

1. ChatView.sendMessage() ä¼˜åŒ–ï¼š
   - ç«‹å³æ¸…ç©ºè¾“å…¥æ¡†
   - å¼‚æ­¥æ”¶èµ·é”®ç›˜ï¼ˆæ”¾åœ¨å•ç‹¬çš„ Task ä¸­ï¼‰
   - å‘é€æ¶ˆæ¯æ”¾åœ¨å¦ä¸€ä¸ª Task

2. ChatManager.sendMessage() æ·»åŠ ä¹è§‚æ›´æ–°ï¼š
   - å‘é€å‰ç«‹å³åˆ›å»ºæœ¬åœ°æ¶ˆæ¯å¹¶æ·»åŠ åˆ° messages
   - ä½¿ç”¨ä¸´æ—¶ UUID æ ‡è¯†
   - å‘é€æˆåŠŸåä¿ç•™ï¼ˆRealtime ä¼šå¸¦æ¥çœŸå®æ¶ˆæ¯ï¼Œéœ€è¦å»é‡ï¼‰
   - å‘é€å¤±è´¥åç§»é™¤æœ¬åœ°æ¶ˆæ¯

3. Message ç»“æ„ä½“éœ€è¦æ·»åŠ åˆå§‹åŒ–æ–¹æ³•ï¼Œæ”¯æŒæœ¬åœ°åˆ›å»º
```

### ğŸ“ ä¹è§‚æ›´æ–°ä»£ç 

```swift
// ChatManager.sendMessage()
func sendMessage(content: String) async throws {
    // ... éªŒè¯ä»£ç  ...

    // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ˜¾ç¤º
    let tempId = UUID()
    let optimisticMessage = Message(
        id: tempId,
        senderId: userId,
        content: content,
        messageType: .broadcast,
        senderName: senderName,
        createdAt: Date()
    )
    messages.append(optimisticMessage)

    do {
        try await messageUploader.upload(...)
    } catch {
        // å¤±è´¥æ—¶ç§»é™¤
        messages.removeAll { $0.id == tempId }
        throw error
    }
}
```

### ğŸ’¡ ä»€ä¹ˆæ˜¯ä¹è§‚æ›´æ–°ï¼Ÿ

| æ–¹å¼ | æµç¨‹ | ç”¨æˆ·æ„Ÿå— |
|------|------|----------|
| ä¼ ç»Ÿæ–¹å¼ | å‘é€ â†’ ç­‰æœåŠ¡å™¨ â†’ ç­‰ Realtime â†’ æ˜¾ç¤º | æ…¢ï¼Œè¦ç­‰1-2ç§’ |
| ä¹è§‚æ›´æ–° | å‘é€ â†’ **ç«‹å³æ˜¾ç¤º** â†’ åå°ä¸Šä¼  | å¿«ï¼Œå³æ—¶åé¦ˆ |

è¿™æ˜¯ç°ä»£èŠå¤©åº”ç”¨çš„æ ‡å‡†åšæ³•ã€‚

---

## ğŸš€ ä»»åŠ¡9: æ–°ç©å®¶é»˜è®¤è®¾å¤‡ (15åˆ†é’Ÿ)

### ç›®æ ‡

æ–°ç”¨æˆ·æ³¨å†Œåè‡ªåŠ¨è·å¾—å°æ”¶éŸ³æœºã€‚

### ğŸ¤– AIæç¤ºè¯

```
è¯·ä¿®æ”¹ AuthManager.swiftï¼Œåœ¨æ³¨å†ŒæˆåŠŸåæ·»åŠ é»˜è®¤è®¾å¤‡ï¼š

1. æ³¨å†ŒæˆåŠŸåè°ƒç”¨ createDefaultDevice(for: userId)

2. createDefaultDevice æ–¹æ³•ï¼š
   - é€šè¿‡ REST API æ’å…¥è®¾å¤‡åˆ° player_devices è¡¨
   - è®¾å¤‡ç±»å‹: radio
   - è®¾å¤‡åç§°: å°æ”¶éŸ³æœº
   - range_km: Double.infinityï¼ˆæ— é™æ¥æ”¶èŒƒå›´ï¼‰
   - is_active: true

3. åˆ·æ–° DeviceManager.loadDevices()

å‚è€ƒ StoreKitManager çš„ addDeviceViaREST æ–¹æ³•ã€‚
```

---

## ğŸš€ ä»»åŠ¡10: æµ‹è¯•å®Œæ•´æµç¨‹ (20åˆ†é’Ÿ)

### æµ‹è¯•æ­¥éª¤

1. **æ–°ç”¨æˆ·æ³¨å†Œ**
   - æ³¨å†Œæ–°è´¦æˆ·
   - ç¡®è®¤è‡ªåŠ¨è·å¾—å°æ”¶éŸ³æœº
   - ç¡®è®¤åªèƒ½æ¥æ”¶ä¸èƒ½å‘é€

2. **è´­ä¹°è®¾å¤‡**
   - æ‰“å¼€è®¾å¤‡å•†åº—
   - è´­ä¹°å¯¹è®²æœº
   - ç¡®è®¤è´­ä¹°æˆåŠŸå¼¹çª—

3. **éªŒè¯æ¿€æ´»**
   - ç¡®è®¤æ¿€æ´»è®¾å¤‡åˆ‡æ¢ä¸ºå¯¹è®²æœº
   - ç¡®è®¤å¯ä»¥å‘é€æ¶ˆæ¯

4. **å‘é€æµ‹è¯•**
   - å‘é€æ¶ˆæ¯
   - ç¡®è®¤ç«‹å³æ˜¾ç¤ºï¼ˆä¹è§‚æ›´æ–°ï¼‰
   - ç¡®è®¤å¯¹æ–¹æ”¶åˆ°

### âœ… æˆåŠŸæ ‡å‡†

- [ ] æ–°ç”¨æˆ·è‡ªåŠ¨è·å¾—æ”¶éŸ³æœº
- [ ] æ”¶éŸ³æœºç”¨æˆ·ä¸èƒ½å‘é€
- [ ] è´­ä¹°æµç¨‹æ­£å¸¸
- [ ] è´­ä¹°åè‡ªåŠ¨åˆ‡æ¢è®¾å¤‡
- [ ] å‘é€æ¶ˆæ¯æ— å¡é¡¿

---

## ğŸš¨ å¸¸è§é—®é¢˜æ±‡æ€»

### Q1: StoreKit é…ç½®æ–‡ä»¶ä¸ç”Ÿæ•ˆ

**åŸå› **: Scheme æ²¡æœ‰é…ç½®

**è§£å†³**: Product â†’ Scheme â†’ Edit Scheme â†’ Run â†’ Options â†’ StoreKit Configuration

### Q2: è´­ä¹°æˆåŠŸä½†è®¾å¤‡æ²¡æ·»åŠ 

**æ’æŸ¥**:
1. æ£€æŸ¥ Supabase RLS ç­–ç•¥
2. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—
3. ç¡®è®¤ user_id æ­£ç¡®

### Q3: è®¾å¤‡åˆ—è¡¨ä¸ºç©º

**æ’æŸ¥**:
1. ç¡®è®¤ç”¨æˆ·å·²ç™»å½•
2. æ£€æŸ¥ player_devices è¡¨æ•°æ®
3. æŸ¥çœ‹ DeviceManager æ—¥å¿—

### Q4: æ¢å¤è´­ä¹°ä¸å·¥ä½œ

**åŸå› **: æœ¬åœ° StoreKit é…ç½®æ²¡æœ‰æŒä¹…åŒ–è´­ä¹°è®°å½•

**è¯´æ˜**: è¿™æ˜¯æ­£å¸¸çš„ï¼Œä¸Šçº¿åç”¨çœŸå® App Store å°±ä¼šæ­£å¸¸

---

## ğŸ“Š æœ¬æ—¥å­¦ä¹ æ€»ç»“

### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| StoreKit 2 | åº”ç”¨å†…è´­ä¹° |
| Supabase | è®¾å¤‡æ•°æ®å­˜å‚¨ |
| Swift Actor | å¹¶å‘å®‰å…¨ |
| SwiftUI | å•†åº—ç•Œé¢ |

### AIåä½œè¦ç‚¹

1. **æä¾›æ—¥å¿—**: é‡åˆ°é—®é¢˜æ—¶ï¼ŒæŠŠæ§åˆ¶å°æ—¥å¿—ç»™AIåˆ†æ
2. **åˆ†æ­¥éª¤**: å¤æ‚åŠŸèƒ½æ‹†åˆ†æˆå°ä»»åŠ¡
3. **è¯´æ˜ä¸Šä¸‹æ–‡**: å‘Šè¯‰AIå‚è€ƒé¡¹ç›®ä¸­å“ªäº›æ–‡ä»¶
4. **éªŒè¯ä¿®å¤**: æ¯æ¬¡ä¿®æ”¹åç«‹å³æµ‹è¯•

### å¼€å‘ç»éªŒ

1. **StoreKit 2 æ¯” 1 ç®€å•**: async/await + è‡ªåŠ¨éªŒè¯
2. **æœ¬åœ°æµ‹è¯•å¾ˆæ–¹ä¾¿**: ä¸éœ€è¦ App Store Connect
3. **ä¹è§‚æ›´æ–°æå‡ä½“éªŒ**: æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
4. **è®¾å¤‡æ¿€æ´»è¦ä¸»åŠ¨**: æ¯æ¬¡åŠ è½½éƒ½é€‰æ‹©æœ€ä½³è®¾å¤‡

---

## ğŸ¯ æ‰©å±•ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰

### L4 è·ç¦»è¿‡æ»¤
- æ ¹æ®è®¾å¤‡é€šè®¯èŒƒå›´è¿‡æ»¤æ¶ˆæ¯
- è¶…å‡ºèŒƒå›´çš„æ¶ˆæ¯æ˜¾ç¤ºä¸º "ä¿¡å·å¼±"

### L5 è®¾å¤‡å‡çº§
- æ¶ˆè€—èµ„æºå‡çº§è®¾å¤‡å±æ€§
- å¢åŠ ç”µæ± å®¹é‡ã€ä¿¡å·å¼ºåº¦

### çœŸå® IAP ä¸Šçº¿
- åœ¨ App Store Connect åˆ›å»ºäº§å“
- é…ç½®é“¶è¡Œè´¦æˆ·
- æ²™ç›’æµ‹è¯•
- æäº¤å®¡æ ¸

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [StoreKit 2 å®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/storekit/in-app_purchase/)
- [Testing StoreKit in Xcode](https://developer.apple.com/documentation/storekit/in-app_purchase/testing_in-app_purchases_in_xcode/)
- [Supabase RLS æ–‡æ¡£](https://supabase.com/docs/guides/auth/row-level-security)

---

**æ­å–œå®Œæˆ Day 6ï¼** ğŸ‰

ä½ å·²ç»æŒæ¡äº†ï¼š
- æ¸¸æˆå†…è®¾å¤‡ç³»ç»Ÿè®¾è®¡
- StoreKit 2 å†…è´­é›†æˆ
- è´­ä¹°ä¸æ•°æ®åº“åŒæ­¥
- æ€§èƒ½ä¼˜åŒ–æŠ€å·§

è¿™æ˜¯å•†ä¸šåŒ–æ¸¸æˆçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼

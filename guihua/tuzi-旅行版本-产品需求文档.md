# 兔子旅行 - 产品需求文档 (PRD)

**版本**: v1.0
**更新日期**: 2025年12月5日
**产品定位**: 真实世界探索 + 虚拟领地建造

---

## 一、产品概述

### 1.1 产品愿景

将真实世界的探索体验，转化为游戏内的资产和记忆。玩家通过在真实世界中行走探索，发现有趣的地点（咖啡店、公园、书店等），获得建造材料，在圈定的领地上建造个性化建筑，形成专属的虚拟打卡地图。

### 1.2 核心理念

- **真实连接**：游戏与真实世界的 POI（兴趣点）绑定
- **探索奖励**：出门走动获得实际游戏收益
- **创造表达**：建筑系统让玩家留下个人印记
- **社交互动**：其他玩家可以看到你的建筑和打卡点

### 1.3 游戏循环

```
探索（获得物资）→ 圈地（获得空间）→ 建造（消耗物资）→ 打卡点
      ↑                                              │
      └──────────────── 继续探索 ←───────────────────┘
```

---

## 二、核心模块概览

| 模块       | 功能              | 状态     | 分支              |
| -------- | --------------- | ------ | --------------- |
| **探索模块** | 发现真实世界 POI，获得物资 | 🚧 开发中 | feature/explore |
| **圈地模块** | GPS 轨迹围成领地      | ✅ 已完成  | main            |
| **建筑模块** | 在领地上建造建筑        | ✅ 基础完成 | main            |
| **通讯模块** | 玩家间聊天互动         | ✅ 基础完成 | main            |

---

## 三、探索模块 (核心开发中)

### 3.1 模块概述

玩家在真实世界行走，系统检测附近的 POI（咖啡店、公园等），探索结束后 AI 生成探索日记和物资奖励。

### 3.2 POI 类型定义

| POI 类型 | 英文标识              | MapKit 类别                               | 图标  | 主要产出物资   |
| ------ | ----------------- | --------------------------------------- | --- | -------- |
| 咖啡店    | cafe              | MKPointOfInterestCategory.cafe          | ☕   | 木材、装饰品   |
| 公园     | park              | MKPointOfInterestCategory.park          | 🌳  | 石材、植物    |
| 书店     | bookstore         | MKPointOfInterestCategory.store         | 📚  | 知识碎片、蓝图  |
| 餐厅     | restaurant        | MKPointOfInterestCategory.restaurant    | 🍽️ | 金币、食材    |
| 景点     | attraction        | MKPointOfInterestCategory.museum        | 🏛️ | 稀有材料、纪念品 |
| 商场     | mall              | MKPointOfInterestCategory.store         | 🛒  | 金币、装饰品   |
| 便利店    | convenience_store | MKPointOfInterestCategory.store         | 🏪  | 基础材料     |
| 健身房    | gym               | MKPointOfInterestCategory.fitnessCenter | 💪  | 钢材、工具    |

### 3.3 物资类型定义（建造材料）

| 物资  | 英文标识       | 图标  | 用途     | 主要来源   |
| --- | ---------- | --- | ------ | ------ |
| 木材  | wood       | 🪵  | 基础建筑   | 咖啡店、书店 |
| 石材  | stone      | 🪨  | 基础建筑   | 公园、景点  |
| 钢材  | steel      | 🔩  | 高级建筑   | 健身房、商场 |
| 玻璃  | glass      | 🪟  | 装饰建筑   | 商场、餐厅  |
| 金币  | coin       | 💰  | 通用货币   | 餐厅、商场  |
| 蓝图  | blueprint  | 📜  | 解锁建筑类型 | 书店、景点  |
| 装饰品 | decoration | 🎨  | 美化建筑   | 咖啡店、景点 |
| 植物  | plant      | 🌿  | 环境美化   | 公园     |
| 食材  | ingredient | 🥬  | 特殊建筑   | 餐厅     |
| 纪念品 | souvenir   | 🎁  | 稀有收藏   | 景点     |

### 3.4 探索流程

#### 阶段1：首次启动（POI 预加载）

```
┌─────────────────────────────────────────────────────────────────┐
│  App 首次启动                                                    │
├─────────────────────────────────────────────────────────────────┤
│  1. 获取用户 GPS 位置                                            │
│  2. 上传位置到 user_profiles 表                                  │
│  3. 调用 MapKit 搜索 1km 范围内的 POI                            │
│     - cafe, park, bookstore, restaurant, attraction...          │
│  4. 存入 pois 表（只存位置和类型，不生成物资）                     │
│                                                                 │
│  注意：此阶段不调用 AI，只是把 POI 点存下来供后续检测              │
└─────────────────────────────────────────────────────────────────┘
```

#### 阶段2：开始探索

```
┌─────────────────────────────────────────────────────────────────┐
│  玩家点击"开始探索"                                              │
├─────────────────────────────────────────────────────────────────┤
│  1. 记录探索起始时间和位置                                       │
│  2. 初始化"本次发现的 POI 列表"为空                              │
│  3. 开始 GPS 追踪                                                │
│  4. 启动 POI 检测定时器（每 5 秒检测一次）                        │
└─────────────────────────────────────────────────────────────────┘
```

#### 阶段3：探索中（POI 检测）

```
┌─────────────────────────────────────────────────────────────────┐
│  探索过程中（循环）                                               │
├─────────────────────────────────────────────────────────────────┤
│  每 5 秒执行：                                                   │
│  1. 获取当前位置                                                 │
│  2. 查询数据库：100 米范围内有哪些 POI？                          │
│  3. 遍历结果：                                                   │
│     - 如果该 POI 已在"本次发现列表"中 → 跳过                      │
│     - 如果是新发现的 POI：                                       │
│       a. 弹出发现提示："发现 [星巴克咖啡] ☕"                      │
│       b. 播放音效 + 震动反馈                                     │
│       c. 添加到"本次发现列表"                                    │
│  4. 继续记录轨迹（距离、面积）                                    │
└─────────────────────────────────────────────────────────────────┘
```

#### 阶段4：结束探索（AI 汇总）

```
┌─────────────────────────────────────────────────────────────────┐
│  玩家点击"结束探索"                                              │
├─────────────────────────────────────────────────────────────────┤
│  1. 收集探索数据：                                               │
│     - 行走距离：2.3km                                            │
│     - 探索面积：15000㎡                                          │
│     - 探索时长：45分钟                                           │
│     - 发现的 POI 列表：                                          │
│       · 星巴克咖啡 (cafe) - 地址xxx                              │
│       · 中山公园 (park) - 地址xxx                                │
│       · 西西弗书店 (bookstore) - 地址xxx                         │
│                                                                 │
│  2. 调用千问 AI API：                                            │
│     - 发送：探索数据 + POI 列表                                  │
│     - 请求：生成探索日记 + 物资清单                              │
│                                                                 │
│  3. AI 返回结果：                                                │
│     - narrative: "阳光正好，你从星巴克出发..."（探索日记）        │
│     - items: [{wood: 12}, {stone: 8}, ...]（物资列表）           │
│     - mood: "relaxed"（氛围）                                    │
│                                                                 │
│  4. 显示结果弹窗                                                 │
│  5. 物资存入玩家背包                                             │
└─────────────────────────────────────────────────────────────────┘
```

### 3.5 AI 提示词模板（旅行风格）

```
你是一个旅行探索 App 的叙事助手。用户刚完成一次城市漫步，数据如下：

- 行走距离：{distance} 公里
- 探索时长：{duration} 分钟
- 探索面积：{area} 平方米
- 发现的地点：
  · {poi_1_name} ({poi_1_type}) - {poi_1_address}
  · {poi_2_name} ({poi_2_type}) - {poi_2_address}
  ...

请完成以下任务：

1. 生成一段 80-120 字的探索日记，要求：
   - 第一人称视角
   - 温暖治愈的文风
   - 提及用户发现的具体地点
   - 描述城市漫步的感受和细节

2. 根据发现的地点类型，生成合理的物资奖励：
   - 咖啡店：主要产出木材、装饰品
   - 公园：主要产出石材、植物
   - 书店：主要产出蓝图、知识碎片
   - 餐厅：主要产出金币、食材
   - 景点：主要产出稀有材料、纪念品
   - 物资数量与探索距离/时长正相关

返回 JSON 格式：
{
  "narrative": "探索日记文本...",
  "mood": "relaxed|excited|peaceful|adventurous",
  "items": [
    {"id": "wood", "name": "木材", "quantity": 12, "icon": "🪵"},
    {"id": "stone", "name": "石材", "quantity": 8, "icon": "🪨"},
    ...
  ]
}
```

### 3.6 结果展示 UI

```
┌─────────────────────────────────────┐
│       ✅ 探索完成!                   │
├─────────────────────────────────────┤
│ ▶ 探索统计 (可展开)                  │
│   - 时长：45分钟                     │
│   - 距离：2.3km                      │
│   - 面积：15000㎡                    │
│   - 发现：3个地点                    │
├─────────────────────────────────────┤
│ 📖 探索日记                          │
│                                     │
│ 阳光正好，你从星巴克出发，咖啡的香    │
│ 气还萦绕在鼻尖。穿过中山公园的林荫    │
│ 小道，落叶在脚下沙沙作响。最后在西    │
│ 西弗书店驻足，翻了几页喜欢的书...    │
│                                     │
├─────────────────────────────────────┤
│ 🎒 获得物资                          │
│                                     │
│ 🪵 木材           x 12              │
│ 🪨 石材           x 8               │
│ 📜 蓝图碎片       x 2               │
│ 💰 金币           x 50              │
│                                     │
├─────────────────────────────────────┤
│         [ 收下物资 ]                 │
└─────────────────────────────────────┘
```

### 3.7 数据库表设计

#### pois 表（POI 兴趣点）

```sql
CREATE TABLE pois (
    id TEXT PRIMARY KEY,              -- MapKit 生成的 ID
    name TEXT NOT NULL,               -- POI 名称（如：星巴克咖啡）
    poi_type TEXT NOT NULL,           -- 类型（cafe/park/bookstore...）
    latitude DOUBLE PRECISION,        -- 纬度
    longitude DOUBLE PRECISION,       -- 经度
    address TEXT,                     -- 地址
    source TEXT DEFAULT 'mapkit',     -- 数据来源
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### exploration_discoveries 表（探索发现记录）

```sql
CREATE TABLE exploration_discoveries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES auth.users(id),
    session_id UUID,                  -- 关联探索会话
    poi_id TEXT REFERENCES pois(id),
    discovered_at TIMESTAMP DEFAULT NOW()
);
```

#### exploration_sessions 表（探索会话）- 扩展

```sql
-- 现有字段基础上添加：
ALTER TABLE exploration_sessions ADD COLUMN discovered_pois JSONB;
-- 存储格式：[{"poi_id": "xxx", "name": "星巴克", "type": "cafe"}, ...]
```

### 3.8 技术实现要点

#### MapKit POI 搜索

```swift
// POICandidateManager.swift
func searchNearbyPOIs(location: CLLocation) async -> [POICandidate] {
    let request = MKLocalPointsOfInterestRequest(center: location.coordinate, radius: 1000)
    request.pointOfInterestFilter = MKPointOfInterestFilter(including: [
        .cafe,
        .park,
        .restaurant,
        .museum,
        .store,
        .fitnessCenter
    ])

    let search = MKLocalSearch(request: request)
    let response = try await search.start()

    return response.mapItems.map { item in
        POICandidate(
            id: item.placemark.name ?? UUID().uuidString,
            name: item.name ?? "未知地点",
            type: mapCategoryToType(item.pointOfInterestCategory),
            latitude: item.placemark.coordinate.latitude,
            longitude: item.placemark.coordinate.longitude,
            address: item.placemark.formattedAddress
        )
    }
}
```

#### POI 距离检测

```swift
// ExplorationManager.swift
func checkNearbyPOIs(currentLocation: CLLocation) async {
    // 查询 100 米内的 POI
    let nearbyPOIs = await poiManager.queryPOIsWithinRadius(
        center: currentLocation,
        radiusMeters: 100
    )

    for poi in nearbyPOIs {
        // 检查是否已发现
        if !discoveredPOIIds.contains(poi.id) {
            // 新发现！
            discoveredPOIIds.insert(poi.id)
            discoveredPOIs.append(poi)

            // 触发发现事件
            await MainActor.run {
                showDiscoveryAlert(poi: poi)
                playDiscoverySound()
                triggerHapticFeedback()
            }
        }
    }
}
```

---

## 四、圈地模块 (已完成)

### 4.1 模块概述

玩家通过 GPS 轨迹绘制领地边界，形成闭环后即可占领该区域。

### 4.2 功能层级

| 层级  | 功能                      | 状态  |
| --- | ----------------------- | --- |
| L1  | 开始/结束圈地、路径记录、实时显示       | ✅   |
| L2  | 闭环检测、最少点数、最小面积          | ✅   |
| L3  | 自交叉检测、速度防作弊             | ✅   |
| L4  | GeoJSON 上传、面积计算         | ✅   |
| L5  | 多人碰撞检测、Edge Function 验证 | ✅   |
| L6  | 新手礼包、里程碑奖励              | ✅   |

### 4.3 核心规则

- **闭环条件**：起点与终点距离 ≤ 30 米
- **最少点数**：≥ 10 个 GPS 点
- **最小面积**：≥ 100 平方米
- **禁止自交叉**：轨迹不能形成 8 字形
- **禁止重叠**：不能与其他玩家领地重叠

### 4.4 与探索模块的关系

```
探索模块                         圈地模块
────────                        ────────
记录行走轨迹     ──共享数据──→    使用相同轨迹
发现 POI 点                      轨迹围成领地
获得物资奖励                      领地可建造建筑
```

---

## 五、建筑模块 (基础完成)

### 5.1 模块概述

玩家在自己的领地上建造建筑，消耗探索获得的物资，建筑可作为打卡点。

### 5.2 功能层级

| 层级  | 功能          | 状态       |
| --- | ----------- | -------- |
| L1  | 建筑模板定义、列表展示 | ✅        |
| L2  | 地图选点放置、位置验证 | ✅        |
| L3  | 建造计时、进度显示   | ✅        |
| L4  | 领地建筑查询、地图标注 | ✅        |
| L5  | 升级/维修/拆除    | 🟡 UI 完成 |
| L6  | AI 生成建筑图片   | ❌ 待开发    |

### 5.3 建筑类型（旅行版）

| 建筑  | 所需物资         | 效果       | 建造时间 |
| --- | ------------ | -------- | ---- |
| 木屋  | 木材x20        | 存储+50    | 5分钟  |
| 石塔  | 石材x30        | 视野+100m  | 10分钟 |
| 咖啡亭 | 木材x15, 装饰品x5 | 休息恢复     | 8分钟  |
| 观景台 | 钢材x20, 玻璃x10 | 发现范围+50m | 15分钟 |
| 书屋  | 木材x25, 蓝图x3  | 蓝图产出+10% | 20分钟 |
| 花园  | 石材x10, 植物x20 | 美观度+50   | 12分钟 |

### 5.4 AI 生成建筑图片（待开发）

```
建造完成时：
1. 收集建筑信息（类型、等级、位置）
2. 调用 Gemini API 生成建筑图片
3. 存储图片 URL 到数据库
4. 该位置变成"打卡点"
5. 其他玩家路过可以看到
```

### 5.5 与探索模块的关系

```
探索模块                         建筑模块
────────                        ────────
获得木材、石材等      ──消耗──→    建造建筑
获得蓝图             ──解锁──→    新建筑类型
获得金币             ──加速──→    缩短建造时间
```

---

## 六、通讯模块 (基础完成)

### 6.1 模块概述

玩家之间的聊天互动系统，包括官方频道、附近玩家、私聊等。

### 6.2 功能层级

| 层级  | 功能           | 状态    |
| --- | ------------ | ----- |
| L1  | 通讯中心 TabView | ✅     |
| L2  | 官方频道聊天       | ✅     |
| L3  | 公共广场         | ✅     |
| L4  | 附近玩家查找       | ✅     |
| L5  | 一对一私聊        | ✅     |
| L6  | 消息路由、设备矩阵    | ❌ 待开发 |

### 6.3 与探索模块的关系

```
探索模块                         通讯模块
────────                        ────────
实时位置上报         ──共享──→    附近玩家检测
发现特殊 POI         ──通知──→    频道广播
```

---

## 七、数据流总览

```
┌─────────────────────────────────────────────────────────────────┐
│                         真实世界                                 │
│                                                                 │
│    [咖啡店]    [公园]    [书店]    [餐厅]    [景点]              │
│        ↓         ↓        ↓         ↓         ↓                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                         MapKit API
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        Supabase 数据库                           │
│                                                                 │
│  ┌─────────┐   ┌─────────────┐   ┌──────────┐   ┌───────────┐  │
│  │  pois   │   │ territories │   │buildings │   │ inventory │  │
│  │ (POI点) │   │   (领地)    │   │  (建筑)  │   │  (背包)   │  │
│  └─────────┘   └─────────────┘   └──────────┘   └───────────┘  │
│       ↑               ↑               ↑              ↑         │
└───────┼───────────────┼───────────────┼──────────────┼─────────┘
        │               │               │              │
┌───────┼───────────────┼───────────────┼──────────────┼─────────┐
│       │               │               │              │         │
│  ┌────┴────┐    ┌─────┴─────┐   ┌─────┴─────┐  ┌─────┴─────┐   │
│  │探索模块 │    │ 圈地模块  │   │ 建筑模块  │  │ 背包模块  │   │
│  │         │    │           │   │           │  │           │   │
│  │ 发现POI │───→│ 绘制领地  │───→│ 放置建筑 │←──│ 消耗物资  │   │
│  │ 获得物资│────────────────────────────────────→│ 存储物资  │   │
│  └─────────┘    └───────────┘   └───────────┘  └───────────┘   │
│                                                                 │
│                         iOS App                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 八、技术栈

| 层级    | 技术                                                       |
| ----- | -------------------------------------------------------- |
| 前端    | SwiftUI + MapKit + CoreLocation                          |
| 后端    | Supabase (PostgreSQL + Auth + Realtime + Edge Functions) |
| AI 文本 | 阿里云千问 (qwen-plus)                                        |
| AI 图片 | Google Gemini (待接入)                                      |
| 地图数据  | Apple MapKit POI                                         |

---

## 九、API 配置

### 千问 API（文本生成）

```
端点: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
模型: qwen-plus
认证: Bearer {QWEN_API_KEY}
```

### Gemini API（图片生成）

```
端点: 待配置
模型: 待确定
认证: 待配置
```

---

## 十、开发优先级

### Phase 1：探索模块完善（当前）

1. ✅ AI 物资描述生成（已完成基础版）
2. 🚧 MapKit POI 搜索集成
3. 🚧 POI 发现检测逻辑
4. 🚧 探索结果 UI 改造（旅行风格）
5. 🚧 物资类型更新（建造材料）

### Phase 2：系统联通

1. ⏳ 探索物资 → 背包系统
2. ⏳ 背包物资 → 建筑消耗
3. ⏳ 建筑完成 → AI 图片生成

### Phase 3：社交增强

1. ⏳ 打卡点分享
2. ⏳ 建筑访客记录
3. ⏳ 排行榜系统

---

## 十一、文件清单

### 探索模块

| 文件                                 | 用途            | 状态           |
| ---------------------------------- | ------------- | ------------ |
| `ExplorationManager.swift`         | 探索业务逻辑        | ✅ 需扩展 POI 检测 |
| `ExplorationView.swift`            | 探索主界面         | ✅ 需改 UI 风格   |
| `AILootDescriptionGenerator.swift` | AI 物资生成       | ✅ 需改提示词风格    |
| `POICandidateManager.swift`        | MapKit POI 搜索 | ❌ 待创建        |
| `POIDiscoveryManager.swift`        | POI 发现检测      | ❌ 待创建        |

### 圈地模块

| 文件                       | 用途     | 状态    |
| ------------------------ | ------ | ----- |
| `ClaimingManager.swift`  | 圈地业务逻辑 | ✅ 已完成 |
| `ClaimingView.swift`     | 圈地界面   | ✅ 已完成 |
| `TerritoryManager.swift` | 领地管理   | ✅ 已完成 |

### 建筑模块

| 文件                            | 用途   | 状态    |
| ----------------------------- | ---- | ----- |
| `Building.swift`              | 数据模型 | ✅ 已完成 |
| `BuildingManager.swift`       | 业务逻辑 | ✅ 已完成 |
| `BuildingListView.swift`      | 建筑列表 | ✅ 已完成 |
| `BuildingPlacementView.swift` | 放置界面 | ✅ 已完成 |
| `BuildingDetailView.swift`    | 详情页  | ✅ 已完成 |

### 通讯模块

| 文件                        | 用途   | 状态    |
| ------------------------- | ---- | ----- |
| `CommunicationHub.swift`  | 通讯中心 | ✅ 已完成 |
| `ChannelChatView.swift`   | 频道聊天 | ✅ 已完成 |
| `DirectChatView.swift`    | 私聊界面 | ✅ 已完成 |
| `NearbyPlayersView.swift` | 附近玩家 | ✅ 已完成 |

---

## 十二、更新日志

| 日期         | 版本   | 更新内容          |
| ---------- | ---- | ------------- |
| 2025-12-05 | v1.0 | 初始版本，整合所有模块需求 |

---

## 附录：与原项目（末世版）的对比

| 维度         | 原项目（末世版）       | 新项目（旅行版）       |
| ---------- | -------------- | -------------- |
| **风格**     | 末世生存、紧张刺激      | 城市漫步、温暖治愈      |
| **POI 类型** | 医院、超市、废墟       | 咖啡店、公园、书店      |
| **物资类型**   | 药品、食物、武器       | 木材、石材、蓝图       |
| **物资用途**   | 生存消耗           | 建造建筑           |
| **叙述风格**   | "穿过废墟，危险四伏..." | "阳光正好，咖啡飘香..." |
| **核心循环**   | 探索→生存→战斗       | 探索→圈地→建造       |

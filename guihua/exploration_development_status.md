# 探索模块开发进度追踪

**更新日期**: 2025年12月6日
**模块状态**: 🚧 开发中

---

## 一、整体进度概览

| 功能点 | 状态 | 说明 |
|--------|------|------|
| POI类型定义（旅行风格） | ✅ 已完成 | cafe/bookstore/restaurant/park等 |
| MapKit POI搜索 | ✅ 已完成 | ExploreTabView中实现 |
| 候选表提交 | ✅ 已完成 | mapkit_poi_candidates表 |
| Edge Function处理 | ✅ 已完成 | process-poi-candidates v8 |
| PostGIS空间查询 | ✅ 已完成 | get_pois_within_radius RPC |
| 探索Tab界面 | ✅ 已完成 | 已发现历史 + 探索模式 |
| POI发现弹窗 | ⚠️ 待测试 | 走近100米触发 |
| AI叙事生成 | ⚠️ 待测试 | 通义千问API |
| 物资奖励系统 | ❌ 未完成 | 需要背包系统支持 |
| 探索结果UI | ❌ 未完成 | 需要旅行风格改造 |

---

## 二、已完成功能详情

### 2.1 POI类型定义（旅行风格）

**文件**: `tuzi-fuke/POI.swift`

```swift
enum POIType: String, Codable, CaseIterable {
    case cafe = "cafe"              // 咖啡店
    case bookstore = "bookstore"    // 书店
    case restaurant = "restaurant"  // 餐厅
    case park = "park"              // 公园
    case attraction = "attraction"  // 景点
    case mall = "mall"              // 商场
    case convenience_store          // 便利店
    case gym = "gym"                // 健身房
    case other = "other"            // 其他
}
```

### 2.2 MapKit POI搜索

**文件**: `tuzi-fuke/ExploreTabView.swift`（已删除，需恢复或移到别处）

搜索关键词配置：
```swift
let searchConfigs = [
    ("cafe", ["咖啡", "咖啡店", "星巴克", "瑞幸"], 1000),
    ("bookstore", ["书店", "书城", "新华书店"], 1500),
    ("restaurant", ["餐厅", "美食", "网红店"], 1000),
    ("park", ["公园", "广场", "花园"], 2000),
    ("attraction", ["景点", "博物馆", "展览馆"], 2500),
    ("mall", ["商场", "购物中心", "万达"], 2000),
    ("convenience_store", ["便利店", "7-11", "全家"], 800),
    ("gym", ["健身房", "游泳馆", "运动"], 1500),
]
```

### 2.3 Edge Function处理

**名称**: `process-poi-candidates` v8

功能：
- 按距离优先处理候选
- 旅行风格类型映射
- 生成描述模板
- 写入PostGIS location字段

### 2.4 数据库POI统计

当前pois表数据分布：

| 类型 | 数量 |
|------|------|
| cafe | 75 |
| park | 75 |
| convenience_store | 72 |
| gym | 70 |
| attraction | 68 |
| bookstore | 60 |
| mall | 36 |
| restaurant | 29 |
| **总计** | **485** |

### 2.5 探索Tab界面

**文件**: `tuzi-fuke/ExploreTabView.swift`

两个分段：
- **已发现**: 显示用户历史上发现过的POI（从user_poi_discoveries表）
- **探索模式**: 开始新的探索任务

---

## 三、待测试功能

### 3.1 POI发现弹窗

**预期行为**:
1. 用户移动时，每5秒检测一次附近POI
2. 走近POI 100米范围内
3. 弹出发现提示："发现 [星巴克咖啡] ☕"
4. 播放音效 + 震动反馈
5. 记录到user_poi_discoveries表

**测试方法**:
1. 打开app，开始探索
2. 走向附近的咖啡店/书店
3. 观察是否弹出发现提示
4. 检查控制台日志

**相关代码**: `POIManager.swift` - `checkNearbyPOIs()`

### 3.2 AI叙事生成

**预期行为**:
1. 点击"结束探索"
2. 收集探索数据（距离、面积、时长、发现的POI）
3. 调用通义千问API
4. 生成旅行风格叙述
5. 显示在结果页面

**测试方法**:
1. 开始探索，走动一段距离
2. 发现至少1个POI
3. 结束探索
4. 观察是否生成AI叙述

**相关代码**: `ExplorationManager.swift` - AI调用部分

---

## 四、未完成功能

### 4.1 物资奖励系统

**需求**:
根据发现的POI类型，生成对应物资奖励

| POI类型 | 主要产出 |
|---------|----------|
| 咖啡店 | 木材、装饰品 |
| 公园 | 石材、植物 |
| 书店 | 蓝图、知识碎片 |
| 餐厅 | 金币、食材 |
| 景点 | 稀有材料、纪念品 |

**依赖**:
- 背包系统（inventory表）
- 物资定义（item_definitions表）

**待开发**:
1. 创建物资类型定义（旅行风格）
2. AI返回物资清单
3. 物资存入背包
4. 物资消耗（建筑建造）

### 4.2 探索结果UI改造

**当前状态**: 使用末日风格UI

**需要改造**:
1. 结果弹窗样式（参考PRD第3.6节设计稿）
2. 探索日记展示区域
3. 获得物资列表
4. 收下物资按钮

**设计稿**:
```
┌─────────────────────────────────────┐
│       ✅ 探索完成!                   │
├─────────────────────────────────────┤
│ ▶ 探索统计 (可展开)                  │
│   - 时长：45分钟                     │
│   - 距离：2.3km                      │
│   - 面积：15000㎡                    │
│   - 发现：3个地点                    │
├─────────────────────────────────────┤
│ 📖 探索日记                          │
│                                     │
│ 阳光正好，你从星巴克出发，咖啡的香    │
│ 气还萦绕在鼻尖...                   │
│                                     │
├─────────────────────────────────────┤
│ 🎒 获得物资                          │
│                                     │
│ 🪵 木材           x 12              │
│ 🪨 石材           x 8               │
│                                     │
├─────────────────────────────────────┤
│         [ 收下物资 ]                 │
└─────────────────────────────────────┘
```

### 4.3 MapKit搜索入口问题

**当前问题**:
之前的MapKit搜索代码在ExploreTabView中，但被重构时删除了。

**需要决定**:
1. 在哪里触发MapKit搜索？
   - 选项A: 首次启动时（InitializationManager）
   - 选项B: 进入探索Tab时
   - 选项C: 开始探索时

2. 是否需要定期刷新？
   - 用户移动到新区域后，需要搜索新的POI

**建议**: 按原项目做法，在首次启动时搜索一次，后续移动时增量搜索。

---

## 五、待修复问题

### 5.1 ExploreTabView的MapKit搜索代码被删除

**问题**: 重构时把MapKit搜索逻辑删了，现在只有加载已发现历史的功能。

**影响**: 新用户不会自动搜索附近POI，需要手动触发。

**解决方案**:
1. 恢复MapKit搜索代码
2. 放到合适的位置（建议InitializationManager或POIManager）

### 5.2 探索模式UI待完善

**当前**: 直接嵌入ExplorationView

**需要**:
- 显示附近POI数量
- 显示已发现/未发现状态
- 探索中实时显示发现的POI

---

## 六、开发优先级建议

### 高优先级（本周完成）

1. **恢复MapKit搜索逻辑**
   - 决定搜索触发时机
   - 恢复搜索代码

2. **测试POI发现流程**
   - 实际出门测试
   - 确认弹窗和记录正常

3. **测试AI叙事生成**
   - 确认API调用成功
   - 检查生成内容质量

### 中优先级（下周完成）

4. **探索结果UI改造**
   - 按PRD设计稿改造
   - 旅行风格

5. **物资系统基础**
   - 定义物资类型
   - AI返回物资清单

### 低优先级（后续完成）

6. **背包系统**
   - 物资存储
   - 物资消耗

7. **建筑消耗物资**
   - 连接探索和建筑模块

---

## 七、测试清单

### 首次启动测试

- [ ] 定位成功
- [ ] MapKit搜索执行
- [ ] 候选提交到数据库
- [ ] Edge Function处理候选
- [ ] 正式POI表有数据
- [ ] 主地图显示附近POI

### 探索流程测试

- [ ] 点击开始探索
- [ ] GPS追踪启动
- [ ] 走近POI触发发现弹窗
- [ ] 发现记录保存到数据库
- [ ] 探索Tab显示已发现历史

### 结束探索测试

- [ ] 点击结束探索
- [ ] AI叙事生成成功
- [ ] 显示探索日记
- [ ] 显示获得物资（待开发）

---

## 八、相关文件清单

| 文件 | 用途 | 状态 |
|------|------|------|
| POI.swift | POI数据模型 | ✅ 已改旅行风格 |
| POIManager.swift | POI业务逻辑 | ⚠️ 需确认发现逻辑 |
| ExploreTabView.swift | 探索Tab | ⚠️ MapKit搜索被删 |
| ExplorationManager.swift | 探索管理 | ⚠️ 需测试AI调用 |
| ExplorationView.swift | 探索界面 | ⚠️ 需改UI风格 |
| process-poi-candidates | Edge Function | ✅ v8已部署 |

---

## 九、下一步行动

1. **今天**: 实际测试POI发现和AI叙事
2. **明天**: 根据测试结果修复问题
3. **后续**: 开发物资系统和UI改造

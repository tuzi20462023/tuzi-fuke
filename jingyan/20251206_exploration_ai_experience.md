# æ¢ç´¢ç³»ç»Ÿä¸AIé›†æˆå¼€å‘ç»éªŒæ€»ç»“

**æ—¥æœŸ**: 2025å¹´12æœˆ6æ—¥
**é¡¹ç›®**: tuzi-fuke (æ—…è¡Œé£æ ¼ç‰ˆæœ¬)
**åŠŸèƒ½**: POIæ¢ç´¢ç³»ç»Ÿã€Edge Functionå¤„ç†ã€AIå™äº‹ç”Ÿæˆ

---

## èƒŒæ™¯

å°†æœ«æ—¥ç”Ÿå­˜é£æ ¼çš„POIç³»ç»Ÿè½¬æ¢ä¸ºæ—…è¡Œé£æ ¼ï¼š

- POIç±»å‹ä»"åŒ»é™¢ã€åŠ æ²¹ç«™ã€å·¥å‚"æ”¹ä¸º"å’–å•¡åº—ã€ä¹¦åº—ã€é¤å…ã€å…¬å›­"
- èµ„æºä»"é£Ÿç‰©ã€è¯å“ã€æ­¦å™¨"æ”¹ä¸º"æ˜ä¿¡ç‰‡ã€çºªå¿µç« ã€ç‰¹è‰²å°åƒ"
- æ¢ç´¢ç»“æŸæ—¶è°ƒç”¨é€šä¹‰åƒé—®AIç”Ÿæˆæ—…è¡Œå™è¿°

---

## ä¸AIå¯¹è¯çš„ç»éªŒ

### 1. è®©AIå…ˆåˆ†æå†åŠ¨æ‰‹

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:

```
åŸé¡¹ç›®çš„å€™é€‰è¡¨æ˜¯æ€ä¹ˆå¡«å……çš„ï¼Ÿ
Edge Functionæ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ï¼Ÿ
å…ˆçœ‹çœ‹å…ˆä¸è¦ä»£ç 
```

**æ•ˆæœ**: AIä¼šå…ˆåˆ†æåŸé¡¹ç›®æ¶æ„ï¼Œé¿å…ç›²ç›®å†™ä»£ç ã€‚

### 2. æä¾›æ—¥å¿—è®©é—®é¢˜å¯è¿½è¸ª

**é”™è¯¯ç¤ºèŒƒ**:

```
POIæ²¡æœ‰ç”Ÿæˆ
```

**æ­£ç¡®ç¤ºèŒƒ**:

```
æˆ‘é¦–æ¬¡æ‰“å¼€æ¢ç´¢Tabï¼Œæ§åˆ¶å°æ—¥å¿—å¦‚ä¸‹ï¼š

22:47:20.352 âœ… [POI] PostGIS æŸ¥è¯¢å®Œæˆï¼Œå…± 0 ä¸ª POI
22:48:42.031 ğŸ“ [æ¢ç´¢Tab] æäº¤äº† 485 ä¸ª POI å€™é€‰
22:49:04.919 âœ… [æ¢ç´¢Tab] Edge Function è°ƒç”¨æˆåŠŸ
22:49:05.091 âœ… [POI] PostGIS æŸ¥è¯¢å®Œæˆï¼Œå…± 0 ä¸ª POI

ä¸ºä»€ä¹ˆæäº¤äº†485ä¸ªå€™é€‰ï¼Œå¤„ç†åè¿˜æ˜¯0ä¸ªPOIï¼Ÿ
```

**æ•ˆæœ**: AIç«‹å³å‘ç°é—®é¢˜åœ¨Edge Functionçš„å¤„ç†é€»è¾‘ã€‚

### 3. è¯¢é—®å…·ä½“ç»†èŠ‚è€Œä¸æ˜¯ç¬¼ç»Ÿé—®é¢˜

**é”™è¯¯ç¤ºèŒƒ**:

```
é¤å…æ€ä¹ˆæ²¡æœ‰ï¼Ÿ
```

**æ­£ç¡®ç¤ºèŒƒ**:

```
ç°åœ¨POIåˆ—è¡¨æœ‰3ä¸ªåœ°ç‚¹ï¼ˆå’–å•¡å’Œä¹¦åº—ï¼‰ï¼Œä½†æ²¡æœ‰é¤å…ã€‚
å€™é€‰è¡¨æœ‰485æ¡è®°å½•ï¼ŒEdge Functionæ—¥å¿—æ˜¾ç¤ºåªå¤„ç†äº†100æ¡ã€‚
é¤å…å€™é€‰æ˜¯ä¸æ˜¯è¿˜æ²¡è¢«å¤„ç†ï¼Ÿå…ˆä¸è¦ä»£ç å…ˆåé¦ˆ
```

**æ•ˆæœ**: AIèƒ½å‡†ç¡®å®šä½é—®é¢˜ï¼ˆEdge Functionåªå–å‰100æ¡ï¼Œé¤å…åœ¨åé¢ï¼‰ã€‚

### 4. è®©AIå¯¹æ¯”åŸé¡¹ç›®åšæ³•

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:

```
åŸé¡¹ç›®å’‹åšçš„ï¼Ÿï¼Ÿ/Users/mikeliu/Desktop/tuzi-earthlord å…ˆä¸è¦å†™ä»£ç å…ˆçœ‹çœ‹
```

**æ•ˆæœ**: AIå‘ç°åŸé¡¹ç›®ï¼š
- å€™é€‰è¡¨æ˜¯é¢„å¡«å……çš„
- æ¯æ¬¡åªéšæœºé€‰1ä¸ªPOI
- æŒ‰è·ç¦»æ’åº

### 5. ç†æ¸…æ¶æ„å†åŠ¨æ‰‹

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:

```
ä¸»åœ°å›¾çš„POIåˆ—è¡¨å’Œæ¢ç´¢Tabçš„é™„è¿‘åœ°ç‚¹æ˜¯ä¸æ˜¯åŒä¸€ä¸ªæ„æ€ï¼Ÿ
åŸé¡¹ç›®çš„èµ„æºTabé‡Œçš„POIæ¢ç´¢æ˜¯æ˜¾ç¤ºä»€ä¹ˆçš„ï¼Ÿ
å…ˆç†æ¸…æ¥šåƒä¸‡ä¸è¦å…ˆå†™ä»£ç 
```

**æ•ˆæœ**: é¿å…é‡å¤å®ç°ç›¸åŒåŠŸèƒ½ï¼Œæ˜ç¡®ï¼š
- ä¸»åœ°å›¾ï¼šæ˜¾ç¤ºé™„è¿‘å¾…å‘ç°POI
- æ¢ç´¢Tabï¼šæ˜¾ç¤ºå·²å‘ç°POIå†å²

---

## é‡åˆ°çš„æ ¸å¿ƒ Bug åŠè§£å†³æ–¹æ¡ˆ

### Bug 1: PostGISæŸ¥è¯¢è¿”å›0ä¸ªPOI

**é—®é¢˜ç°è±¡**:

```
âœ… [POI] PostGIS æŸ¥è¯¢å®Œæˆï¼Œå…± 0 ä¸ª POI
```

æ•°æ®åº“æœ‰100æ¡POIè®°å½•ï¼Œä½†æŸ¥è¯¢è¿”å›ç©ºã€‚

**é—®é¢˜åˆ†æ**:

æ£€æŸ¥æ•°æ®åº“å‘ç° `location` å­—æ®µå…¨æ˜¯ NULLï¼š

```sql
SELECT id, name, location FROM pois LIMIT 5;
-- location å…¨æ˜¯ NULL
```

`get_pois_within_radius` RPCå‡½æ•°ä¾èµ– `location` å­—æ®µè¿›è¡Œç©ºé—´æŸ¥è¯¢ã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. æ‰¹é‡æ›´æ–°ç°æœ‰POIçš„locationå­—æ®µï¼š

```sql
UPDATE pois
SET location = ST_SetSRID(ST_MakePoint(longitude, latitude), 4326)::geography
WHERE location IS NULL AND latitude IS NOT NULL AND longitude IS NOT NULL;
```

2. ä¿®æ”¹Edge Functionï¼Œæ’å…¥æ—¶åŒæ—¶å†™å…¥locationï¼š

```typescript
const { error: insertError } = await supabase.from("pois").insert({
  name: candidate.name,
  latitude: candidate.latitude,
  longitude: candidate.longitude,
  // â˜… é‡è¦ï¼šåŒæ—¶å†™å…¥ PostGIS location å­—æ®µ
  location: `SRID=4326;POINT(${candidate.longitude} ${candidate.latitude})`,
  // ...
});
```

---

### Bug 2: Edge Functionåªå¤„ç†å‰100æ¡å€™é€‰

**é—®é¢˜ç°è±¡**:

- å€™é€‰è¡¨æœ‰485æ¡ï¼ˆåŒ…å«é¤å…ï¼‰
- åªç”Ÿæˆäº†100æ¡æ­£å¼POIï¼ˆéƒ½æ˜¯å’–å•¡ä¹¦åº—ï¼‰
- é¤å…æ²¡æœ‰å‡ºç°

**é—®é¢˜åˆ†æ**:

Edge Functionä»£ç ï¼š

```typescript
const { data, error } = await supabase
  .from("mapkit_poi_candidates")
  .select("*")
  .eq("processed", false)
  .limit(100);  // â† åªå–å‰100æ¡ï¼
```

MapKitæœç´¢æ—¶ï¼Œå’–å•¡å’Œä¹¦åº—çš„å…³é”®è¯æ’åœ¨å‰é¢ï¼Œå…ˆå…¥åº“ã€‚
Edge Functionå–å‰100æ¡æœªå¤„ç†çš„ï¼Œåˆšå¥½éƒ½æ˜¯å’–å•¡ä¹¦åº—ã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. ä¿®æ”¹Edge FunctionæŒ‰è·ç¦»ä¼˜å…ˆå¤„ç†ï¼š

```typescript
// ä½¿ç”¨ RPC å‡½æ•°æŒ‰è·ç¦»æŸ¥è¯¢é™„è¿‘çš„å€™é€‰ï¼ˆè·ç¦»è¿‘çš„ä¼˜å…ˆï¼‰
const { data: nearbyCandidates } = await supabase
  .rpc("get_nearby_poi_candidates", {
    p_lat: userLat,
    p_lon: userLon,
    p_radius_meters: radiusMeters,
    p_limit: 200  // å¢åŠ å¤„ç†æ•°é‡
  });
```

2. å¢åŠ å•æ¬¡å¤„ç†æ•°é‡åˆ°200-500æ¡

3. æ‰‹åŠ¨è°ƒç”¨Edge Functionå¤„ç†å‰©ä½™å€™é€‰

---

### Bug 3: æ¢ç´¢Tabå’Œä¸»åœ°å›¾POIåˆ—è¡¨åŠŸèƒ½é‡å¤

**é—®é¢˜ç°è±¡**:

- ä¸»åœ°å›¾æœ‰"é™„è¿‘POIåˆ—è¡¨"
- æ¢ç´¢Tabä¹Ÿæœ‰"é™„è¿‘åœ°ç‚¹"
- ä¸¤ä¸ªæ˜¾ç¤ºçš„å†…å®¹ä¸€æ ·

**é—®é¢˜åˆ†æ**:

åŸé¡¹ç›®æ¶æ„ï¼š
- **ä¸»åœ°å›¾**ï¼šé™„è¿‘å¾…å‘ç°POIï¼ˆå®æ—¶å‘ç°ï¼‰
- **èµ„æºTab > POIæ¢ç´¢**ï¼šå·²å‘ç°POIå†å²æ±‡æ€»

æˆ‘ä»¬çš„é¡¹ç›®æŠŠ"é™„è¿‘åœ°ç‚¹"æ”¾åœ¨äº†æ¢ç´¢Tabï¼Œå’Œä¸»åœ°å›¾é‡å¤äº†ã€‚

**è§£å†³æ–¹æ¡ˆ**:

é‡æ„ExploreTabViewï¼š
- å°†"é™„è¿‘åœ°ç‚¹"æ”¹ä¸º"å·²å‘ç°"
- ä» `user_poi_discoveries` è¡¨åŠ è½½å†å²è®°å½•
- æ˜¾ç¤ºå‘ç°æ—¶é—´ã€æ”¶é›†èµ„æºæ•°ç­‰

```swift
// ä» user_poi_discoveries è¡¨åŠ è½½å·²å‘ç°çš„POIå†å²
let response = try await supabase.database
    .from("user_poi_discoveries")
    .select("*")
    .eq("user_id", value: userId.uuidString)
    .order("discovered_at", ascending: false)
    .execute()
```

---

### Bug 4: AIå™è¿°ç”Ÿæˆå¤±è´¥

**é—®é¢˜ç°è±¡**:

æ¢ç´¢ç»“æŸæ—¶æ²¡æœ‰ç”ŸæˆAIå™è¿°ï¼Œæ§åˆ¶å°æ— ç›¸å…³æ—¥å¿—ã€‚

**é—®é¢˜åˆ†æ**:

æ£€æŸ¥ä»£ç å‘ç°è°ƒç”¨é€šä¹‰åƒé—®APIçš„åœ°æ–¹ç¼ºå°‘API Keyé…ç½®ã€‚

**è§£å†³æ–¹æ¡ˆ**:

1. åœ¨Supabase Edge Functionç¯å¢ƒå˜é‡ä¸­é…ç½® `QWEN_API_KEY`
2. ç¡®ä¿æ¢ç´¢ç»“æŸæ—¶æ­£ç¡®è°ƒç”¨AIç”Ÿæˆæ¥å£

```swift
// ExplorationManager.swift
appLog(.info, category: "AI", message: "å¼€å§‹è°ƒç”¨é€šä¹‰åƒé—® API...")
appLog(.info, category: "AI", message: "æ¢ç´¢æ•°æ®: è·ç¦»=\(distance)ç±³, é¢ç§¯=\(area)mÂ², æ—¶é•¿=\(duration)ç§’")
```

---

## æ¶æ„ç†è§£

### æ•°æ®æµ

```
1. ç”¨æˆ·æ‰“å¼€æ¢ç´¢Tab
   â†“
2. MapKitæœç´¢é™„è¿‘åº—é“ºï¼ˆå’–å•¡ã€é¤å…ã€ä¹¦åº—ç­‰ï¼‰
   â†“
3. å­˜å…¥å€™é€‰è¡¨ mapkit_poi_candidates
   â†“
4. Edge Functionå¤„ç†å€™é€‰
   - æŒ‰è·ç¦»æ’åº
   - æ˜ å°„POIç±»å‹ï¼ˆæ—…è¡Œé£æ ¼ï¼‰
   - ç”Ÿæˆæè¿°å’Œèµ„æºæ•°é‡
   â†“
5. å­˜å…¥æ­£å¼è¡¨ poisï¼ˆå«PostGIS locationå­—æ®µï¼‰
   â†“
6. ç”¨æˆ·ç§»åŠ¨æ—¶ï¼ŒPostGISç©ºé—´æŸ¥è¯¢é™„è¿‘POI
   â†“
7. èµ°è¿‘100ç±³å†…ï¼Œè§¦å‘å‘ç°å¼¹çª—
   â†“
8. è®°å½•åˆ° user_poi_discoveries è¡¨
```

### å…³é”®è¡¨

| è¡¨å | ç”¨é€” |
|------|------|
| mapkit_poi_candidates | MapKitæœç´¢ç»“æœï¼ˆä¸´æ—¶ï¼‰ |
| pois | æ­£å¼POIï¼ˆå«PostGISç©ºé—´å­—æ®µï¼‰ |
| user_poi_discoveries | ç”¨æˆ·å‘ç°å†å² |

### POIç±»å‹æ˜ å°„

| åŸç±»å‹ï¼ˆæœ«æ—¥ï¼‰ | æ–°ç±»å‹ï¼ˆæ—…è¡Œï¼‰ |
|----------------|----------------|
| hospital | other |
| gas_station | other |
| supermarket | mall |
| - | cafe |
| - | bookstore |
| - | restaurant |
| - | park |
| - | attraction |

---

## æ ¸å¿ƒç»éªŒæ€»ç»“

### æŠ€æœ¯ç»éªŒ

1. **PostGISç©ºé—´å­—æ®µå¿…é¡»å†™å…¥**: `location` å­—æ®µç”¨äºè·ç¦»æŸ¥è¯¢ï¼Œä¸èƒ½æ˜¯NULL
2. **Edge Functionå¤„ç†é¡ºåº**: æŒ‰è·ç¦»æ’åºï¼Œä¼˜å…ˆå¤„ç†ç”¨æˆ·é™„è¿‘çš„å€™é€‰
3. **é¿å…åŠŸèƒ½é‡å¤**: ç†æ¸…åŸé¡¹ç›®æ¶æ„ï¼Œä¸»åœ°å›¾è´Ÿè´£å‘ç°ï¼ŒTabè´Ÿè´£å†å²
4. **ç±»å‹æ˜ å°„è¡¨**: æ—…è¡Œé£æ ¼éœ€è¦è‡ªå·±çš„ç±»å‹å®šä¹‰å’Œæè¿°æ¨¡æ¿

### ä¸AIåä½œç»éªŒ

1. **å…ˆåé¦ˆå†ä»£ç **: "å…ˆä¸è¦å†™ä»£ç å…ˆçœ‹çœ‹" è®©AIå…ˆåˆ†æ
2. **æä¾›å®Œæ•´æ—¥å¿—**: æ—¥å¿—ä¸­çš„å…·ä½“æ•°å­—å¸®åŠ©å®šä½é—®é¢˜
3. **å¯¹æ¯”åŸé¡¹ç›®**: è®©AIé˜…è¯»åŸé¡¹ç›®ä»£ç æ‰¾åˆ°æ­£ç¡®åšæ³•
4. **è¿½é—®ç»†èŠ‚**: "æ˜¯ä¸æ˜¯è¿™ä¸ªç­›é€‰æœ‰é—®é¢˜ï¼Ÿ" å¼•å¯¼AIæ·±å…¥åˆ†æ
5. **ç†æ¸…æ¶æ„**: "è¿™ä¸¤ä¸ªæ˜¯ä¸æ˜¯ä¸€ä¸ªæ„æ€ï¼Ÿ" é¿å…é‡å¤å®ç°

---

## å‚è€ƒæ–‡ä»¶

- `/Users/mikeliu/Desktop/tuzi-fuke/tuzi-fuke/ExploreTabView.swift`
- `/Users/mikeliu/Desktop/tuzi-fuke/tuzi-fuke/POIManager.swift`
- `/Users/mikeliu/Desktop/tuzi-fuke/tuzi-fuke/POI.swift`
- Edge Function: `process-poi-candidates` (v8)
- RPC Function: `get_pois_within_radius`, `get_nearby_poi_candidates`

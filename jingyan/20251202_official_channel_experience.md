# å®˜æ–¹é¢‘é“ç³»ç»Ÿå¼€å‘ç»éªŒæ€»ç»“

**æ—¥æœŸ**: 2025å¹´12æœˆ2æ—¥
**é¡¹ç›®**: tuzi-fuke (åœ°çƒæ–°ä¸»å¤åˆ»ç‰ˆ)
**åŠŸèƒ½**: L2 å®˜æ–¹é¢‘é“ç³»ç»Ÿ - é¢‘é“åˆ—è¡¨ã€è®¢é˜…ã€å®æ—¶æ¶ˆæ¯

---

## èƒŒæ™¯

åœ¨å®Œæˆ L1 åŸºç¡€é€šè®¯ç³»ç»Ÿåï¼Œéœ€è¦å®ç°å®˜æ–¹é¢‘é“åŠŸèƒ½ï¼š
- é¢„è®¾çš„å®˜æ–¹é¢‘é“ï¼ˆç”Ÿå­˜æŒ‡å—ã€å¹¸å­˜è€…æ–°é—»ã€æ¯æ—¥ä»»åŠ¡ã€ç´§æ€¥å¹¿æ’­ï¼‰
- ç”¨æˆ·å¯è®¢é˜…/å–æ¶ˆè®¢é˜…é¢‘é“
- é¢‘é“æ¶ˆæ¯å®æ—¶æ¨é€
- æœåŠ¡å™¨è‡ªåŠ¨å‘é€é¢‘é“æ¶ˆæ¯ï¼ˆpg_cronï¼‰

---

## ä¸AIå¯¹è¯çš„ç»éªŒ

### 1. å…ˆè®©AIåˆ†ææºä»£ç 

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:
```
è¯·å¸®æˆ‘åˆ†æ /path/to/source ç›®å½•ä¸‹çš„é¢‘é“ç›¸å…³ä»£ç ï¼Œ
æ€»ç»“å‡ºæ ¸å¿ƒåŠŸèƒ½å’Œæ•°æ®ç»“æ„ï¼Œ
ç„¶åå‘Šè¯‰æˆ‘åœ¨æ–°é¡¹ç›®ä¸­éœ€è¦å®ç°å“ªäº›æ–‡ä»¶ã€‚
```

**æ•ˆæœ**: AIä¼šå¯¹æ¯”æºä»£ç å’Œå½“å‰é¡¹ç›®ï¼Œåˆ—å‡ºç¼ºå¤±çš„åŠŸèƒ½ï¼Œé¿å…é—æ¼ã€‚

### 2. é‡åˆ°é—®é¢˜æ—¶æä¾›æˆªå›¾+æ—¥å¿—

**é”™è¯¯ç¤ºèŒƒ**:
```
é¢‘é“ä¸å·¥ä½œäº†
```

**æ­£ç¡®ç¤ºèŒƒ**:
```
æˆ‘ç‚¹å‡»è®¢é˜…åç”»é¢æ˜¾ç¤ºè¿˜æ˜¯0è®¢é˜…ï¼Œ
ç„¶åè®¢é˜…åé¢‘é“é‡Œæ²¡æ”¶åˆ°æ¶ˆæ¯ã€‚
è¿™æ˜¯æ—¥å¿—ï¼š[ç²˜è´´æ§åˆ¶å°æ—¥å¿—]
```

**æ•ˆæœ**: æˆªå›¾+æ—¥å¿—è®©AIèƒ½ç²¾å‡†å®šä½é—®é¢˜ï¼Œä¸ç”¨çŒœæµ‹ã€‚

### 3. è®©AIæ£€æŸ¥æ•°æ®åº“æ•°æ®

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:
```
å¸®æˆ‘æŸ¥ä¸€ä¸‹æ•°æ®åº“ï¼š
1. channel_subscriptions è¡¨é‡Œæœ‰æ²¡æœ‰æˆ‘çš„è®¢é˜…è®°å½•
2. communication_channels è¡¨é‡Œ subscriber_count æ˜¯å¤šå°‘
3. channel_messages è¡¨æœ€è¿‘æœ‰æ²¡æœ‰æ–°æ¶ˆæ¯
```

**æ•ˆæœ**: ç›´æ¥çœ‹æ•°æ®åº“èƒ½å¿«é€Ÿåˆ¤æ–­æ˜¯å‰ç«¯é—®é¢˜è¿˜æ˜¯åç«¯é—®é¢˜ã€‚

### 4. æè¿°é¢„æœŸ vs å®é™…

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:
```
é¢„æœŸï¼šæ—¶é—´åº”è¯¥æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸Šæ–¹
å®é™…ï¼šæ—¶é—´æ˜¾ç¤ºåœ¨æ¶ˆæ¯ä¸‹æ–¹
è¯·ä¿®å¤ ChannelMessageBubble çš„å¸ƒå±€
```

**æ•ˆæœ**: æ¸…æ™°çš„å¯¹æ¯”è®©AIçŸ¥é“æ”¹ä»€ä¹ˆã€æ€ä¹ˆæ”¹ã€‚

### 5. è®©AIå¯¹æ¯”ä¸¤å°è®¾å¤‡çš„å·®å¼‚

**æœ‰æ•ˆçš„æç¤ºè¯æ¨¡å¼**:
```
[æˆªå›¾1] æ‰‹æœºAçš„é¢‘é“åˆ—è¡¨
[æˆªå›¾2] æ‰‹æœºBçš„é¢‘é“åˆ—è¡¨
ä¸ºä»€ä¹ˆæ’åˆ—é¡ºåºä¸ä¸€æ ·ï¼Ÿåº”è¯¥ç»Ÿä¸€
```

**æ•ˆæœ**: AIä¼šæ£€æŸ¥æ’åºé€»è¾‘å¹¶ä¿®å¤ã€‚

---

## æŠ€æœ¯å®ç°ç»éªŒ

### 1. æ•°æ®åº“è®¾è®¡

**ä¸‰å¼ æ ¸å¿ƒè¡¨**:

```sql
-- é¢‘é“è¡¨
communication_channels (
    id, channel_name, channel_code, channel_type,
    description, subscriber_count, message_count, ...
)

-- è®¢é˜…å…³ç³»è¡¨
channel_subscriptions (
    id, user_id, channel_id, subscribed_at
)

-- é¢‘é“æ¶ˆæ¯è¡¨
channel_messages (
    id, channel_id, sender_name, content, message_type, created_at
)
```

**å…³é”®ç‚¹**:
- `subscriber_count` é€šè¿‡è§¦å‘å™¨è‡ªåŠ¨æ›´æ–°ï¼Œä¸è¦æ‰‹åŠ¨ç»´æŠ¤
- ä½¿ç”¨ `channel_code` ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼ˆå¦‚ OFF-SURVIVALï¼‰
- å¯ç”¨ RLS ä¿æŠ¤æ•°æ®å®‰å…¨

### 2. è®¢é˜…è®¡æ•°è§¦å‘å™¨

**è¸©å‘**: æœ€åˆç”¨ `+1/-1` å¢å‡æ–¹å¼ï¼Œå¯¼è‡´è®¡æ•°ä¸å‡†

**æ­£ç¡®æ–¹æ¡ˆ**: ç”¨ `COUNT(*)` é‡æ–°è®¡ç®—

```sql
CREATE OR REPLACE FUNCTION update_channel_subscriber_count()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        UPDATE communication_channels
        SET subscriber_count = (
            SELECT COUNT(*) FROM channel_subscriptions
            WHERE channel_id = NEW.channel_id
        )
        WHERE id = NEW.channel_id;
    ELSIF TG_OP = 'DELETE' THEN
        UPDATE communication_channels
        SET subscriber_count = (
            SELECT COUNT(*) FROM channel_subscriptions
            WHERE channel_id = OLD.channel_id
        )
        WHERE id = OLD.channel_id;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 3. è‡ªåŠ¨å‘é€é¢‘é“æ¶ˆæ¯ (pg_cron)

**å¯ç”¨ pg_cron**:
1. Supabase Dashboard â†’ Database â†’ Extensions
2. æœç´¢ `pg_cron` å¹¶å¯ç”¨

**åˆ›å»ºå®šæ—¶ä»»åŠ¡**:
```sql
-- æ¯åˆ†é’Ÿéšæœºç»™ä¸€ä¸ªé¢‘é“å‘æ¶ˆæ¯
SELECT cron.schedule(
    'channel-message-sender',
    '* * * * *',
    'SELECT send_random_channel_message()'
);
```

**æ¶ˆæ¯å‡½æ•°è®¾è®¡**:
- éšæœºé€‰æ‹©ä¸€ä¸ªå®˜æ–¹é¢‘é“
- æ ¹æ®é¢‘é“ç±»å‹é€‰æ‹©åˆé€‚çš„æ¶ˆæ¯å†…å®¹
- éšæœºé€‰ä¸€æ¡å‘é€

### 4. æ¶ˆæ¯åŠ è½½é¡ºåºé—®é¢˜

**è¸©å‘**: ç”¨ `order=created_at.asc` + `limit=50` ä¼šè·å–æœ€æ—©çš„50æ¡

**æ­£ç¡®æ–¹æ¡ˆ**:
```swift
// 1. ä»æ•°æ®åº“è·å–æœ€æ–°50æ¡ï¼ˆå€’åºï¼‰
URLQueryItem(name: "order", value: "created_at.desc")
URLQueryItem(name: "limit", value: "50")

// 2. åœ¨å®¢æˆ·ç«¯åè½¬ï¼Œè®©æ—§æ¶ˆæ¯åœ¨ä¸Šã€æ–°æ¶ˆæ¯åœ¨ä¸‹
return messages.reversed()
```

### 5. Realtime é¢‘é“è®¢é˜…

**å…³é”®ä»£ç **:
```swift
// åªè®¢é˜…å½“å‰é¢‘é“çš„æ¶ˆæ¯
let insertions = await rtChannel.postgresChange(
    InsertAction.self,
    table: "channel_messages",
    filter: "channel_id=eq.\(channel.id.uuidString)"
)

// åœ¨ MainActor ä¸Šæ›´æ–° UI
await MainActor.run {
    if !self.currentChannelMessages.contains(where: { $0.id == message.id }) {
        self.currentChannelMessages.append(message)
    }
}
```

### 6. åˆ—è¡¨æ’åºç»Ÿä¸€

**é—®é¢˜**: ä¸åŒæ‰‹æœºæ˜¾ç¤ºçš„é¢‘é“é¡ºåºä¸ä¸€æ ·

**è§£å†³**: æŒ‰ `channel_code` æ’åº
```swift
// REST API æŸ¥è¯¢
URLQueryItem(name: "order", value: "channel_code.asc")

// æœ¬åœ°æ’åºï¼ˆå·²è®¢é˜…åˆ—è¡¨ï¼‰
subscribedChannels = channels.sorted {
    ($0.channelCode ?? "") < ($1.channelCode ?? "")
}
```

---

## é‡åˆ°çš„é—®é¢˜æ¸…å•

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|-----|------|---------|
| è®¢é˜…åè®¡æ•°è¿˜æ˜¯0 | è§¦å‘å™¨ç”¨å¢å‡æ–¹å¼ä¸å‡†ç¡® | æ”¹ç”¨ COUNT(*) é‡æ–°è®¡ç®— |
| é¢‘é“æ¶ˆæ¯ä¸æ˜¾ç¤º | åŠ è½½äº†æœ€æ—©çš„50æ¡ | æ”¹ä¸ºå€’åºè·å–å†åè½¬ |
| å®æ—¶æ¶ˆæ¯ä¸å‡ºç° | æ²¡åœ¨ MainActor ä¸Šæ›´æ–° | ç”¨ await MainActor.run {} |
| æ—¶é—´æ˜¾ç¤ºåœ¨ä¸‹é¢ | UI å¸ƒå±€é¡ºåºé”™è¯¯ | è°ƒæ•´ VStack ä¸­çš„é¡ºåº |
| ä¸¤å°æ‰‹æœºåˆ—è¡¨é¡ºåºä¸åŒ | æ²¡æœ‰å›ºå®šæ’åº | æŒ‰ channel_code æ’åº |
| åªæœ‰ä¸€ä¸ªé¢‘é“æ”¶åˆ°æ¶ˆæ¯ | pg_cron éšæœºé€‰é¢‘é“ | è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼Œæ¯åˆ†é’Ÿåªå‘ä¸€ä¸ª |

---

## æ–‡ä»¶ç»“æ„

```
tuzi-fuke/
â”œâ”€â”€ CommunicationChannel.swift  # é¢‘é“+æ¶ˆæ¯æ•°æ®æ¨¡å‹
â”œâ”€â”€ ChannelManager.swift        # é¢‘é“ç®¡ç†å™¨ï¼ˆè®¢é˜…/æ¶ˆæ¯/Realtimeï¼‰
â”œâ”€â”€ ChannelListView.swift       # é¢‘é“åˆ—è¡¨ç•Œé¢
â””â”€â”€ ChatView.swift              # èŠå¤©ç•Œé¢ï¼ˆé›†æˆé¢‘é“æ¶ˆæ¯æ˜¾ç¤ºï¼‰
```

---

## å¼€å‘å·¥ä½œæµ

### 1. æ•°æ®åº“å…ˆè¡Œ

å…ˆåœ¨ Supabase åˆ›å»ºè¡¨ã€è§¦å‘å™¨ã€RLS ç­–ç•¥ï¼Œç”¨ SQL Editor æµ‹è¯•æ•°æ®ã€‚

### 2. æ¨¡å‹å¯¹é½

Swift æ¨¡å‹çš„ CodingKeys å¿…é¡»å’Œæ•°æ®åº“å­—æ®µåä¸€è‡´ï¼ˆsnake_caseï¼‰ã€‚

### 3. æ—¥å¿—é©±åŠ¨

åœ¨å…³é”®ä½ç½®æ‰“å°æ—¥å¿—ï¼Œå‡ºé—®é¢˜æ—¶çœ‹æ—¥å¿—å®šä½ï¼š
```swift
print("âœ… [ChannelManager] åŠ è½½äº† \(channels.count) ä¸ªå®˜æ–¹é¢‘é“")
print("ğŸ“¨ [ChannelManager] æ”¶åˆ°æ–°é¢‘é“æ¶ˆæ¯: \(message.content.prefix(20))...")
```

### 4. åŒæœºæµ‹è¯•

æ¯å®Œæˆä¸€ä¸ªåŠŸèƒ½å°±ç”¨ä¸¤å°æ‰‹æœºæµ‹è¯•ï¼Œç¡®ä¿æ•°æ®åŒæ­¥æ­£ç¡®ã€‚

---

## å¾…æ‰©å±•åŠŸèƒ½

- [ ] TTS è¯­éŸ³æ’­æŠ¥é¢‘é“æ¶ˆæ¯
- [ ] æ¶ˆæ¯åˆ†ç±»æ ‡ç­¾ï¼ˆä¸åŒç±»å‹ä¸åŒé¢œè‰²ï¼‰
- [ ] é¢‘é“è¯¦æƒ…é¡µ
- [ ] é¢‘é“æœç´¢å’Œå‘ç°
- [ ] ç§äººé¢‘é“åˆ›å»º

---

## æ€»ç»“

### æ ¸å¿ƒç»éªŒ

1. **è§¦å‘å™¨ç”¨ COUNT ä¸ç”¨å¢å‡**: é¿å…è®¡æ•°ä¸åŒæ­¥
2. **æ¶ˆæ¯åŠ è½½è¦å€’åºå†åè½¬**: è·å–æœ€æ–°Næ¡ï¼Œæ˜¾ç¤ºæ—¶æ—§çš„åœ¨ä¸Š
3. **Realtime æ›´æ–°è¦åœ¨ MainActor**: å¦åˆ™ UI ä¸åˆ·æ–°
4. **åˆ—è¡¨æ’åºè¦å›ºå®š**: ç”¨ channel_code ä¿è¯æ‰€æœ‰è®¾å¤‡ä¸€è‡´
5. **pg_cron æ¯åˆ†é’Ÿåªå‘ä¸€æ¡**: 4ä¸ªé¢‘é“è½®æµæ”¶åˆ°ï¼Œæ˜¯æ­£å¸¸çš„

### ä¸AIåä½œçš„æ ¸å¿ƒç»éªŒ

1. **æä¾›æˆªå›¾+æ—¥å¿—**: è®©AIçœ‹åˆ°ä½ çœ‹åˆ°çš„
2. **æè¿°é¢„æœŸvså®é™…**: æ¸…æ™°çš„å¯¹æ¯”æ›´å®¹æ˜“ä¿®å¤
3. **è®©AIæŸ¥æ•°æ®åº“**: ç›´æ¥çœ‹æ•°æ®åˆ¤æ–­é—®é¢˜åœ¨å“ª
4. **åˆ†æ­¥éª¤è§£å†³**: ä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªé—®é¢˜
5. **è®©AIå¯¹æ¯”æºä»£ç **: é¿å…é—æ¼åŠŸèƒ½
